<!DOCTYPE html>
<html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ëª©ê³µì‹¤ ê´€ë¦¬</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--blue:#3182F6;--blue-h:#1B64DA;--blue-bg:#E8F3FF;--red:#F04452;--red-bg:#FFF0F1;--green:#30B47A;--green-bg:#E8FAF0;--orange:#F59E0B;--orange-bg:#FFF8E1;--gray-50:#F9FAFB;--gray-100:#F2F4F6;--gray-200:#E5E8EB;--gray-400:#B0B8C1;--gray-500:#8B95A1;--gray-600:#6B7684;--gray-700:#4E5968;--gray-800:#333D4B;--gray-900:#191F28;--radius:12px;--shadow:0 1px 3px rgba(0,0,0,.06);--shadow-md:0 4px 12px rgba(0,0,0,.08)}
body{font-family:'Pretendard Variable',-apple-system,system-ui,'Noto Sans KR',sans-serif;background:var(--gray-50);color:var(--gray-900);height:100vh;display:flex;flex-direction:column;overflow:hidden;font-size:14px;line-height:1.5}

/* í—¤ë” */
.hdr{height:56px;background:#fff;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0;gap:12px}
.hdr h1{font-size:17px;font-weight:700;white-space:nowrap}
.hdr-center{display:flex;align-items:center;gap:6px}
.week-display{cursor:pointer;padding:4px 14px;border-radius:8px;transition:.15s;text-align:center;line-height:1.3}
.week-display:hover{background:var(--gray-100)}
.week-display .yw{font-size:13px;font-weight:700;color:var(--gray-800)}
.week-display .dr{font-size:11px;color:var(--gray-500)}
.hdr-right{display:flex;align-items:center;gap:6px}

/* ë²„íŠ¼ */
.btn{cursor:pointer;border:none;border-radius:8px;font-size:12px;font-weight:500;padding:7px 12px;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn-ghost{background:none;color:var(--gray-600)}.btn-ghost:hover{background:var(--gray-100)}
.btn-blue{background:var(--blue);color:#fff}.btn-blue:hover{background:var(--blue-h)}
.btn-outline{background:#fff;border:1px solid var(--gray-200);color:var(--gray-700)}.btn-outline:hover{background:var(--gray-50)}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-danger{color:var(--gray-400)}.btn-danger:hover{color:var(--red);background:var(--red-bg)}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{opacity:.9}

/* ì•Œë¦¼ ë°” */
.alert-bar{background:var(--orange-bg);border-bottom:1px solid #FDEEB8;padding:7px 20px;font-size:12px;font-weight:500;color:#92400E;display:flex;align-items:center;gap:8px;flex-shrink:0}
.alert-bar .alert-close{margin-left:auto;cursor:pointer;opacity:.5;font-size:14px}.alert-bar .alert-close:hover{opacity:1}

/* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
.main{display:flex;flex:1;overflow:hidden}
.left{flex:1;overflow-y:auto;padding:20px}
.right{width:380px;background:#fff;border-left:1px solid var(--gray-200);display:flex;flex-direction:column;flex-shrink:0}

/* ìš”ì•½ ì¹´ë“œ */
.card{background:#fff;border:1px solid var(--gray-200);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:16px}
.summary{display:flex;align-items:center;gap:16px;justify-content:center;flex-wrap:wrap}
.summary-item{text-align:center}
.summary-item .val{font-size:22px;font-weight:800}
.summary-item .lbl{font-size:11px;color:var(--gray-500);margin-top:2px}
.summary-item .val.blue{color:var(--blue)}
.summary-item .val.red{color:var(--red)}
.summary-item .val.small{font-size:12px;font-weight:600;color:var(--gray-700);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sep{width:1px;height:28px;background:var(--gray-200)}

/* ì¼ë³„ ì„¹ì…˜ */
.day-header{display:flex;align-items:center;justify-content:space-between;margin:20px 0 10px}
.day-header .left-part{display:flex;align-items:center;gap:8px}
.day-dot{width:8px;height:8px;border-radius:50%;background:var(--blue)}
.day-header h3{font-size:14px;font-weight:600}
.day-header .date{font-size:12px;color:var(--gray-500)}
.day-header .right-part{display:flex;align-items:center;gap:4px}

/* ê³µíœ´ì¼ */
.day-header.holiday .day-dot{background:var(--red)}
.day-header.holiday h3{color:var(--red)}
.holiday-badge{font-size:10px;color:var(--red);font-weight:600;padding:2px 8px;background:var(--red-bg);border-radius:99px;cursor:pointer}
.holiday-badge:hover{opacity:.8}
.holiday-btn{font-size:11px;padding:3px 8px;border-radius:99px;border:1px dashed var(--gray-300);background:#fff;cursor:pointer;color:var(--gray-400);transition:.15s}
.holiday-btn:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}

/* ì‘ì—… ì¹´ë“œ */
.task{background:#fff;border:1px solid var(--gray-200);border-radius:var(--radius);padding:12px;margin-bottom:8px;display:flex;align-items:flex-start;gap:10px;box-shadow:var(--shadow);transition:box-shadow .15s}
.task:hover{box-shadow:var(--shadow-md)}
.task.has-mat{border-left:3px solid var(--blue)}
.task-num{width:22px;height:22px;border-radius:50%;background:var(--gray-100);color:var(--gray-500);font-size:11px;font-weight:600;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.task-body{flex:1;min-width:0}
.task-body input{width:100%;border:none;outline:none;font-size:13px;color:var(--gray-700);background:transparent;padding:0}
.task-body input::placeholder{color:var(--gray-400)}
.task-body p{font-size:13px;color:var(--gray-700);cursor:text;min-height:20px}
.task-body p.empty{color:var(--gray-400)}
.mats{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.mat-badge{display:inline-flex;align-items:center;gap:4px;background:var(--blue-bg);color:var(--blue);font-size:11px;font-weight:500;padding:3px 8px;border-radius:99px}
.mat-badge .qty{background:var(--blue);color:#fff;font-size:10px;padding:1px 5px;border-radius:99px}
.mat-badge .remove{cursor:pointer;opacity:.5;margin-left:2px;font-size:10px}.mat-badge .remove:hover{opacity:1}
.task-actions{display:flex;gap:3px;opacity:0;transition:opacity .15s}
.task:hover .task-actions{opacity:1}
.task-actions button{width:26px;height:26px;border:none;background:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--gray-400);transition:.15s}
.task-actions .act-add{color:var(--blue)}.task-actions .act-add:hover{background:var(--blue-bg)}
.task-actions .act-edit{color:var(--gray-500)}.task-actions .act-edit:hover{color:var(--blue);background:var(--blue-bg)}
.task-actions .act-del:hover{color:var(--red);background:var(--red-bg)}
.empty-msg{font-size:12px;color:var(--gray-400);padding-left:16px;margin-bottom:8px}
.task-building{display:inline-block;font-size:10px;font-weight:600;color:var(--blue);background:var(--blue-bg);padding:2px 8px;border-radius:99px;margin-bottom:4px}
.task-note{font-size:11px;color:var(--gray-500);margin-top:4px;cursor:text}
.task-edit-area{display:flex;flex-direction:column;gap:6px}
.task-edit-area select{padding:5px 8px;border:1px solid var(--gray-200);border-radius:6px;font-size:11px;outline:none;color:var(--gray-700);background:#fff;max-width:160px}
.task-edit-area select:focus{border-color:var(--blue)}
.task-edit-area input{border:1px solid var(--gray-200)!important;border-radius:6px;padding:5px 8px!important;font-size:12px}
.task-edit-area input:focus{border-color:var(--blue)!important}

/* ì¬ê³  íŒ¨ë„ */
.inv-search{padding:14px;border-bottom:1px solid var(--gray-200)}
.search-wrap{position:relative}
.search-wrap .icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--gray-400);font-size:13px}
.search-wrap input{width:100%;padding:8px 10px 8px 32px;border:1px solid var(--gray-200);border-radius:8px;font-size:13px;outline:none;transition:border .15s}
.search-wrap input:focus{border-color:var(--blue)}
.filter-row{display:flex;gap:5px;margin-top:8px}
.filter-row button{padding:4px 10px;border-radius:99px;border:none;font-size:11px;font-weight:500;cursor:pointer;background:var(--gray-100);color:var(--gray-600);transition:.15s}
.filter-row button.active{background:var(--blue);color:#fff}
.filter-sep{width:1px;background:var(--gray-200);margin:0 2px}
#stockView{display:flex;flex-direction:column;flex:1;overflow:hidden}
.inv-list{flex:1;overflow-y:auto;padding:8px 14px 14px}
.inv-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;transition:background .1s;cursor:pointer}
.inv-item:hover{background:var(--gray-100)}
.inv-item .code{font-size:10px;font-weight:700;color:var(--gray-500);background:var(--gray-100);padding:3px 7px;border-radius:4px;width:46px;text-align:center;flex-shrink:0}
.inv-item .info{flex:1;min-width:0}
.inv-item .info .name{font-size:12px;font-weight:500;color:var(--gray-800);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inv-item .info .sub{font-size:10px;color:var(--gray-400)}
.inv-item .stock{font-size:17px;font-weight:800;min-width:30px;text-align:right}
.inv-item .unit{font-size:10px;color:var(--gray-400);min-width:24px}
.stock.zero{color:var(--gray-400)}.stock.low{color:var(--red)}
.change-badge{font-size:10px;font-weight:700;padding:2px 6px;border-radius:99px;margin-right:4px}
.change-badge.up{background:var(--green-bg);color:var(--green)}
.change-badge.dn{background:var(--red-bg);color:var(--red)}
.inv-footer{padding:12px 14px;border-top:1px solid var(--gray-200);display:flex;gap:8px}
.inv-footer button{flex:1;padding:9px;font-size:12px}

/* íƒ­ */
.inv-tabs{display:flex;border-bottom:1px solid var(--gray-200)}
.inv-tabs button{flex:1;padding:10px;border:none;background:none;font-size:12px;font-weight:500;color:var(--gray-500);cursor:pointer;border-bottom:2px solid transparent;transition:.15s}
.inv-tabs button.active{color:var(--blue);border-bottom-color:var(--blue);font-weight:600}

/* ì¶œê³  ë‚´ì—­ */
.history-item{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--gray-100);font-size:12px}
.history-item .h-badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:99px}
.history-item .h-badge.out{background:var(--red-bg);color:var(--red)}
.history-item .h-badge.in{background:var(--green-bg);color:var(--green)}
.history-item .h-badge.adj{background:var(--orange-bg);color:var(--orange)}
.history-item .h-info{flex:1}
.history-item .h-info .h-name{font-weight:500;color:var(--gray-800)}
.history-item .h-info .h-sub{font-size:11px;color:var(--gray-500)}
.history-item .h-qty{font-weight:700}

/* ëª¨ë‹¬ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:#fff;border-radius:16px;padding:24px;width:440px;max-width:92vw;max-height:80vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,.15)}
.modal.wide{width:560px}
.modal h2{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.modal label{font-size:12px;color:var(--gray-600);display:block;margin-bottom:4px;font-weight:500}
.modal input,.modal select{width:100%;padding:9px 12px;border:1px solid var(--gray-200);border-radius:8px;font-size:13px;outline:none;margin-bottom:12px;transition:border .15s}
.modal input:focus,.modal select:focus{border-color:var(--blue)}
.modal .product-info{background:var(--gray-50);border-radius:var(--radius);padding:14px;margin-bottom:14px}
.modal .product-info .pi-code{font-weight:700;color:var(--blue);font-size:13px}
.modal .product-info .pi-name{font-size:14px;font-weight:600;margin-top:2px}
.modal .product-info .pi-stock{font-size:12px;color:var(--gray-500);margin-top:4px}
.modal-btns{display:flex;gap:8px;margin-top:4px}
.modal-btns button{flex:1;padding:11px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:.15s}
.modal-product{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;transition:.1s}
.modal-product:hover{background:var(--gray-50)}
.modal-product.disabled{opacity:.35;cursor:not-allowed}
.modal-product .mp-code{font-size:10px;font-weight:700;color:var(--gray-500);background:var(--gray-100);padding:3px 7px;border-radius:4px;min-width:46px;text-align:center}
.modal-product .mp-name{flex:1;font-size:12px;font-weight:500;color:var(--gray-800);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.modal-product .mp-stock{font-size:14px;font-weight:800}
.modal-product .mp-unit{font-size:10px;color:var(--gray-400)}
.modal-list{max-height:280px;overflow-y:auto;margin:8px -4px;padding:0 4px}
.pm-row{display:flex;align-items:center;gap:8px;padding:9px 10px;border-bottom:1px solid var(--gray-100);transition:.1s}
.pm-row:hover{background:var(--gray-50)}
.pm-row .pm-code{font-size:10px;font-weight:700;color:var(--gray-500);background:var(--gray-100);padding:3px 7px;border-radius:4px;min-width:46px;text-align:center}
.pm-row .pm-name{flex:1;font-size:12px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pm-row .pm-stock{font-size:12px;font-weight:700;min-width:32px;text-align:right}
.pm-row .pm-unit{font-size:10px;color:var(--gray-400);min-width:24px}
.pm-row .pm-actions{display:flex;gap:4px}
.pm-row .pm-actions button{width:28px;height:28px;border:none;background:none;border-radius:6px;cursor:pointer;font-size:12px;color:var(--gray-400);transition:.15s}
.pm-row .pm-actions button:hover{background:var(--gray-100);color:var(--gray-700)}
.pm-row .pm-actions button.del:hover{color:var(--red);background:var(--red-bg)}
.form-row{display:flex;gap:10px}.form-row>div{flex:1}

/* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
@page{margin:10mm;margin-top:8mm;margin-bottom:8mm}
@media print{
  *{color:#000!important;background:#fff!important;box-shadow:none!important;border-color:#ddd!important}
  body{height:auto;overflow:visible;font-size:11px}
  .hdr,.right,.task-actions,.btn,.no-print,.alert-bar,.holiday-btn{display:none!important}
  .main{display:block;overflow:visible}
  .left{overflow:visible;padding:0}
  .print-header{display:block!important;text-align:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #000}
  .print-header h1{font-size:20px;font-weight:800;margin-bottom:4px}
  .print-header p{font-size:13px;color:#555}
  .card{border:1px solid #ddd;page-break-inside:avoid}
  .task{border:1px solid #ddd;page-break-inside:avoid}
  .task-building{border:1px solid #999;background:#f0f0f0!important;color:#333!important}
  .task-note{font-style:italic}
  .mat-badge{border:1px solid var(--blue);background:#f0f7ff!important}
  .day-header{margin-top:16px}
  .holiday-badge{border:1px solid var(--red)}
  .print-inventory{display:block!important;page-break-before:always;padding-top:20px}
  .print-inventory h2{font-size:16px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #000}
  .print-inventory table{width:100%;border-collapse:collapse;font-size:11px}
  .print-inventory th,.print-inventory td{padding:6px 8px;border:1px solid #ddd;text-align:left}
  .print-inventory th{background:#f5f5f5!important;font-weight:600}
  .print-inventory td.num{text-align:right}
  .print-summary{display:block!important;margin-bottom:20px}
  .print-summary h2{font-size:16px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #000}
  .print-summary table{width:100%;border-collapse:collapse;font-size:11px}
  .print-summary th,.print-summary td{padding:6px 8px;border:1px solid #ddd;text-align:left}
  .print-summary th{background:#f5f5f5!important;font-weight:600}
}
.print-header,.print-inventory,.print-summary{display:none}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--gray-900);color:#fff;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:500;z-index:200;animation:toastIn .3s;box-shadow:0 4px 20px rgba(0,0,0,.2)}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* ë°˜ì‘í˜• */
@media(max-width:768px){
  .main{flex-direction:column}
  .right{width:100%;border-left:none;border-top:1px solid var(--gray-200);max-height:50vh}
  .left{padding:12px}
  .hdr{padding:0 12px;flex-wrap:wrap;height:auto;min-height:56px;padding:8px 12px}
  .hdr h1{font-size:15px}
  .hdr-right{flex-wrap:wrap;gap:4px}
  .summary{gap:10px}
  .task-actions{opacity:1}
}
@media(max-width:480px){
  .modal{padding:16px;width:100%;max-width:100vw;border-radius:12px 12px 0 0}
  .modal-overlay{align-items:flex-end}
}
@media(hover:none){.task-actions{opacity:1}}
#fileInput{display:none}

/* ì‘ì—… ì´ë ¥ */
.th-nav{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-bottom:1px solid var(--gray-200)}
.th-nav .th-label{font-size:14px;font-weight:700;min-width:120px;text-align:center}
.th-mode{display:flex;gap:4px;padding:8px 14px 0}
.th-mode button{padding:4px 12px;border-radius:99px;border:none;font-size:11px;font-weight:500;cursor:pointer;background:var(--gray-100);color:var(--gray-600);transition:.15s}
.th-mode button.active{background:var(--blue);color:#fff}
.th-list{flex:1;overflow-y:auto;padding:10px 14px}
.th-day-hdr{font-size:12px;font-weight:600;color:var(--gray-700);margin:12px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--gray-100)}.th-day-hdr:first-child{margin-top:0}
.th-task{display:flex;align-items:flex-start;gap:8px;padding:7px 10px;border-radius:8px;font-size:12px;transition:.1s}
.th-task:hover{background:var(--gray-50)}
.th-task .th-bld{font-size:10px;font-weight:600;color:var(--blue);background:var(--blue-bg);padding:2px 6px;border-radius:99px;flex-shrink:0;margin-top:1px}
.th-task>div{flex:1;min-width:0}
.th-task .th-desc{color:var(--gray-700)}.th-task .th-mats{font-size:10px;color:var(--gray-500);margin-top:2px}
.th-month-card{background:#fff;border:1px solid var(--gray-200);border-radius:var(--radius);padding:14px;margin-bottom:10px;cursor:pointer;transition:.15s}
.th-month-card:hover{box-shadow:var(--shadow-md)}
.th-month-card .th-mc-title{font-size:14px;font-weight:700;color:var(--gray-800)}
.th-month-card .th-mc-stats{display:flex;gap:16px;margin-top:6px;font-size:12px;color:var(--gray-500)}
.th-month-card .th-mc-stats b{color:var(--gray-800)}
.th-empty{text-align:center;color:var(--gray-400);padding:40px 0;font-size:13px}
</style></head><body>

<!-- ì¸ì‡„ìš© í—¤ë” -->
<div class="print-header"><h1>ëª©ê³µì‹¤ ì£¼ê°„ ì—…ë¬´ë³´ê³ </h1><p id="printDate"></p></div>

<div class="hdr">
  <h1>ëª©ê³µì‹¤ ê´€ë¦¬</h1>
  <div class="hdr-center">
    <button class="btn btn-ghost" onclick="navWeek(-1)">â—€</button>
    <div class="week-display" onclick="openWeekPicker()" title="í´ë¦­í•˜ì—¬ ì—°ë„/ì£¼ì°¨ ë³€ê²½">
      <div class="yw" id="ywText"></div>
      <div class="dr" id="drText"></div>
    </div>
    <button class="btn btn-ghost" onclick="navWeek(1)">â–¶</button>
    <button class="btn btn-outline btn-sm" onclick="goToday()">ì˜¤ëŠ˜</button>
  </div>
  <div class="hdr-right">
    <span id="syncStatus" style="font-size:14px;cursor:pointer;margin-right:4px" onclick="openCloudSettings()" title="í´ë¼ìš°ë“œ ìƒíƒœ"></span>
    <button class="btn btn-outline btn-sm" onclick="exportData()" title="ë°ì´í„° ë‚´ë³´ë‚´ê¸°">ğŸ’¾ ì €ì¥</button>
    <button class="btn btn-outline btn-sm" onclick="document.getElementById('fileInput').click()" title="ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn btn-outline btn-sm" onclick="exportCSV()" title="ì¬ê³  CSV">ğŸ“Š CSV</button>
    <button class="btn btn-blue btn-sm" onclick="printReport()" title="ë³´ê³ ì„œ ì¸ì‡„">ğŸ–¨ï¸ ì¸ì‡„</button>
    <button class="btn btn-outline btn-sm" onclick="openCloudSettings()" title="í´ë¼ìš°ë“œ ì„¤ì •">â˜ï¸</button>
    <button class="btn btn-outline btn-sm" onclick="refreshAll()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
    <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
  </div>
</div>

<!-- ì•Œë¦¼ ë°” -->
<div class="alert-bar" id="alertBar" style="display:none"></div>

<div class="main">
  <div class="left" id="reportPanel"></div>
  <div class="right">
    <div class="inv-tabs">
      <button id="tabStock" class="active" onclick="switchTab('stock')">ì¬ê³  í˜„í™©</button>
      <button id="tabHistory" onclick="switchTab('history')">ì…ì¶œê³  ë‚´ì—­</button>
      <button id="tabTasks" onclick="switchTab('tasks')">ì‘ì—… ì´ë ¥</button>
    </div>
    <div id="stockView">
      <div class="inv-search">
        <div class="search-wrap">
          <span class="icon">ğŸ”</span>
          <input id="searchInput" placeholder="í’ˆëª©ì½”ë“œ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰..." oninput="debouncedRenderInventory()">
        </div>
        <div class="filter-row" id="filterBar"></div>
      </div>
      <div class="inv-list" id="invList"></div>
      <div class="inv-footer">
        <button class="btn btn-outline" onclick="openProductManager()">âš™ï¸ ê´€ë¦¬</button>
        <button class="btn btn-outline" onclick="openInbound()">ğŸ“¦ ì…ê³ </button>
        <button class="btn btn-blue" onclick="openOutbound()">ğŸ“¤ ì¶œê³ </button>
      </div>
    </div>
    <div id="historyView" style="display:none;flex:1;overflow-y:auto;padding:14px"></div>
    <div id="tasksView" style="display:none;flex-direction:column;flex:1;overflow:hidden"></div>
  </div>
</div>

<!-- ì¸ì‡„ìš© ìì¬ ì‚¬ìš© ìš”ì•½ -->
<div class="print-summary" id="printSummary"></div>
<!-- ì¸ì‡„ìš© ì¬ê³  í˜„í™© -->
<div class="print-inventory" id="printInventory"></div>

<div id="modalRoot"></div>

<script>
// === ìƒí’ˆ ì‹œë“œ ë°ì´í„° ===
const PRODUCTS_SEED=[
["A01","ë„ì–´ë¡(ë¬¸ì†ì¡ì´)_ì›í†µí˜•","A","ê°œ",37,52,15],["A02","ë„ì–´ë¡(ë¬¸ì†ì¡ì´)_ìƒìí˜•","A","ê°œ",48,106,58],
["A03","ë„ì–´í´ë¡œì €_ë°©í™”ë¬¸ìš©_K2_840","A","ê°œ",8,23,15],["A03-1","ë„ì–´í´ë¡œì €_ë°©í™”ë¬¸ìš©_K2_630(ì†Œë°©)","A","ê°œ",20,20,0],
["A04","ë„ì–´í´ë¡œì €_ì¼ë°˜ìš©_K_620","A","ê°œ",15,45,30],["A04-1","ë„ì–´í´ë¡œì €_ì¼ë°˜ìš©_K_630","A","ê°œ",14,20,6],
["A05","í™˜í’ê¸°_200DRA","A","ëŒ€",25,50,25],["A06","í™˜í’ê¸°_250DRA","A","ëŒ€",15,32,17],
["A07","í”Œë¡œì–´íŒì§€_ê°•í™”ë¬¸ìš©_ì–‘ìª½ì •ì§€í˜•K2_8400","A","ê°œ",29,54,25],["A07-1","í”Œë¡œì–´íŒì§€ë°©ìˆ˜_ê°•í™”ë¬¸ìš©_ì–‘ìª½ì •ì§€í˜•K_8400WP","A","ê°œ",19,20,1],
["A08","í”Œë¡œì–´íŒì§€_ê°•í™”ë¬¸ìš©_ì–‘ìª½ë…¼ìŠ¤í†±í˜•K_8400N","A","ê°œ",36,40,4],["A09","ë„ì–´ìŠ¤í† í¼(ë¬¸ë°œêµ½)","A","ê°œ",376,385,9],
["A10","ì˜¤ë¥´ë‚´ë¦¬ê½‚ì´ì‡ (ì•„êµë„ì‹œ,ë³´ì¡°ì ê¸ˆì¥ì¹˜)","A","ê°œ",5,9,4],["A11","ê²½ì²©_4ì¸ì¹˜","A","ê°œ",0,0,0],
["A12","Tê²½ì²©","A","ê°œ",34,36,2],["A13","ìš°ì•„ë¯¸ê²½ì²©(ë‚˜ë¹„ê²½ì²©)_2ì¸ì¹˜","A","ê°œ",14,20,6],
["A14","ììœ ê²½ì²©","A","ê°œ",0,0,0],["A15","ìˆ˜ì„±ë³¸ë“œ1KG","A","í¬",0,0,0],
["A16","ìƒë¶€ë³´ì¡°í‚¤_ê°•í™”ë„ì–´í”„ë ˆì„ìš©_M-200","A","ê°œ",15,17,2],["A17","ì†ì¡ì´(1ìí˜•)","A","ì¡°",10,12,2],
["A18","ì†ì¡ì´(Lìí˜•)","A","ì¡°",6,7,1],["A19","ë°©ì¶©ë§_90cm*30m","A","ë¡¤",2,3,1],
["A20","ë°©ì¶©ë§_120cm*30m","A","ë¡¤",2,4,2],["A21","ë°©ì¶©ë§_150cm*30m","A","ë¡¤",0,0,0],
["A22","í…ìŠ¤_6t*300*600mm","A","ê°œ(box)",6,6,0],["A23","ë¹„ëˆ„ê±¸ì´","A","ê°œ",0,0,0],
["A24","ì¢ŒíŒ","A","ê°œ",110,335,225],["A25","ìƒ·ì‹œë¬¸ì†ì¡ì´_í™©ë™ìƒ‰","A","ì¡°",2,3,1],
["A26","ë‹¤ìš©ë„ê²½ì²©_6070ì‹¤ë²„","A","ê°œ",81,93,12],["A27","ê²½ì²©","A","ê°œ",3,8,5],
["A28","í™ë¬¸ê´€ë„ì–´ì²´í¬_ASSAABLOYU500","A","ê°œ",0,0,0],["A29","ê°•í™”ë„ì–´ë‹¨ë°©í–¥ìŠ¤í† í¼","A","ê°œ",21,30,9],
["A30","ìŠ¬ë¼ì´ë”©ë„ì–´ìš©ì ê¸ˆì¥ì¹˜","A","ê°œ",14,15,1],
["B01","ë¼ì™•ëª©ì¬_12ì*0.8ì¹˜*10ì¹˜","B","ê°œ",3,3,0],["B02","ë¼ì™•ëª©ì¬_12ì*1ì¹˜*10ì¹˜","B","ê°œ",5,5,0],
["B03","ë¼ì™•ëª©ì¬_12ì*1ì¹˜*1.5ì¹˜","B","ê°œ",34,34,0],["B04","ë¼ì™•ëª©ì¬_12ì*1.2ì¹˜*2ì¹˜","B","ê°œ",34,34,0],
["B05","ë¼ì™•ëª©ì¬_12ì*1.2ì¹˜*3ì¹˜","B","ê°œ",12,12,0],["B06","ë¼ì™•ëª©ì¬_12ì*1.5ì¹˜*1.5ì¹˜","B","ê°œ",33,33,0],
["B07","ë¼ì™•ëª©ì¬_12ì*2ì¹˜*7ì¹˜","B","ê°œ",5,5,0],["B08","ë¼ì™•ëª©ì¬_12ì*2ì¹˜*2ì¹˜","B","ê°œ",23,23,0],
["B09","ë¼ì™•ëª©ì¬_12ì*2.5ì¹˜*2.5ì¹˜","B","ê°œ",12,12,0],["B10","ë°©ë¶€ëª©_ë°í¬ìš©21*120*3600","B","ê°œ",21,25,4],
["B11","ë°©ë¶€ëª©_ë°í¬ìš©25*140*3600","B","ê°œ",40,40,0],["B12","ë°©ë¶€ëª©_ë°í¬ìš©27*140*3600","B","ê°œ",0,0,0],
["B13","ë°©ë¶€ëª©38*38*3600","B","ê°œ",54,54,0],["B14","ë°©ë¶€ëª©50*150*3600","B","ê°œ",0,0,0],
["B15","ë°©ë¶€ëª©120*210*3600","B","ê°œ",0,6,6],["B16","ë°©ë¶€ëª©_êµ¬ì¡°ìš©38*89*3600","B","ê°œ",3,19,16],
["B17","ë°©ë¶€ëª©_êµ¬ì¡°ìš©38*140*3600","B","ê°œ",0,0,0],["B18","í•©íŒ5*1220*2440","B","ì¥",5,5,0],
["B19","í•©íŒ12*1220*2440","B","ì¥",8,8,0],["B20","í•©íŒ15*1220*2440","B","ì¥",0,0,0],
["B21","í•©íŒ18*1220*2440","B","ì¥",0,0,0],["B22","ëª»1.0ì¸ì¹˜","B","kg",0,0,0],
["B23","ëª»1.5ì¸ì¹˜","B","kg",0,0,0],["B24","ëª»2.0ì¸ì¹˜","B","kg",0,0,0],
["B25","ëª»2.5ì¸ì¹˜","B","kg",0,0,0],["B26","ëª»3.0ì¸ì¹˜","B","kg",0,0,0],
["B27","ëª»3.5ì¸ì¹˜","B","kg",0,0,0],["B28","ë¬´ë‘ëª»0.6ì¸ì¹˜","B","kg",0,0,0],
["B29","ë¬´ë‘ëª»1.0ì¸ì¹˜","B","kg",0,0,0],["B30","ë¬´ë‘ëª»1.5ì¸ì¹˜","B","kg",0,0,0],
["B31","ë¬´ë‘ëª»2.0ì¸ì¹˜","B","kg",0,0,0],["B32","ë¬´ë‘ëª»2.5ì¸ì¹˜","B","kg",0,0,0],
["B33","ë¬´ë‘ëª»3.0ì¸ì¹˜","B","kg",0,0,0],["B34","ì§„ì €ìƒŒë”©ì‹¤ëŸ¬","B","ê°œ",0,0,0]];

const DAY_NAMES=['ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼'];
const DOW_SHORT=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

// === ìƒíƒœ ===
let products=[], yr, wk, days=[], history=[], holidays={}, buildings=[],
    nextId=1, filter='all', catFilter='all', currentTab='stock';
let thYear=new Date().getFullYear(), thMonth=new Date().getMonth()+1, thMode='month';
const BUILDINGS_DEFAULT=['ë³¸ê´€','ë³„ê´€','ê¸°ìˆ™ì‚¬','ì²´ìœ¡ê´€','ê°•ë‹¹','ì‹ë‹¹','ë„ì„œê´€','ì‹¤ìŠµë™'];
let productMap=new Map();
let _debounceTimer;
// í´ë¼ìš°ë“œ ì—°ë™
const CLOUD_URL_DEFAULT='https://script.google.com/a/macros/hongik.ac.kr/s/AKfycbwfrvDEaHLxyixA3qH4xTnZDfpOq46He-eN61GJH7MEZdiMxT3XmGCqHZVW9gM5e-g-/exec';
let SCRIPT_URL=localStorage.getItem('ws3_script_url')||CLOUD_URL_DEFAULT;
let _cloudQueue={},_cloudTimer=null;
function debouncedRenderInventory(){clearTimeout(_debounceTimer);_debounceTimer=setTimeout(renderInventory,150);}

// === ì´ˆê¸°í™” ===
async function init(){
  loadProducts();loadHistory();loadHolidays();loadBuildings();
  goToday();renderFilterBar();renderInventory();renderAlerts();
  if(SCRIPT_URL){
    updateSyncStatus('syncing');
    const ok=await loadFromCloud();
    if(ok){loadProducts();loadHistory();loadHolidays();loadBuildings();loadWeek();renderFilterBar();renderInventory();renderAlerts();updateSyncStatus('synced');}
    else{updateSyncStatus('idle');}
  }
}

function loadProducts(){
  const s=localStorage.getItem('ws3_products');
  if(s){products=JSON.parse(s);}
  else{products=PRODUCTS_SEED.map((p,i)=>({id:i+1,code:p[0],name:p[1],cat:p[2],unit:p[3],stock:p[4],tin:p[5],tout:p[6]}));}
  rebuildProductMap();
  recalcNextId();
}
function rebuildProductMap(){productMap=new Map(products.map(p=>[p.id,p]));}
function recalcNextId(){
  let mx=0;
  products.forEach(p=>{if(p.id>mx)mx=p.id;});
  if(Array.isArray(days)){
    days.forEach(d=>{
      if(d.tasks)d.tasks.forEach(t=>{
        if(t.id>mx)mx=t.id;
        if(t.mats)t.mats.forEach(m=>{if(m.id>mx)mx=m.id;});
      });
    });
  }
  nextId=mx+1;
}

function loadHistory(){const s=localStorage.getItem('ws3_history');history=s?JSON.parse(s):[];}
function loadHolidays(){const s=localStorage.getItem('ws3_holidays');holidays=s?JSON.parse(s):{};}
function loadBuildings(){const s=localStorage.getItem('ws3_buildings');buildings=s?JSON.parse(s):BUILDINGS_DEFAULT.slice();}
function saveBuildings(){safeSave('ws3_buildings',buildings);}
function safeSave(key,data){
  try{localStorage.setItem(key,JSON.stringify(data));queueCloudSave(key.replace('ws3_',''),JSON.stringify(data));}
  catch(e){if(e.name==='QuotaExceededError'||e.code===22){if(history.length>500){history=history.slice(-200);try{localStorage.setItem('ws3_history',JSON.stringify(history));localStorage.setItem(key,JSON.stringify(data));toast('ì €ì¥ ê³µê°„ ë¶€ì¡± â†’ ì˜¤ë˜ëœ ë‚´ì—­ ì •ë¦¬ë¨');return;}catch(e2){}}toast('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë°±ì—…í•´ì£¼ì„¸ìš”.');}else{console.error('ì €ì¥ ì‹¤íŒ¨:',e);}queueCloudSave(key.replace('ws3_',''),JSON.stringify(data));}
}
function saveProducts(){rebuildProductMap();safeSave('ws3_products',products);}
function saveWeek(){safeSave('ws3_week_'+yr+'_'+wk,days);}
function saveHistory(){safeSave('ws3_history',history);}
function saveHolidays(){safeSave('ws3_holidays',holidays);}

// === ì£¼ê°„ ë„¤ë¹„ê²Œì´ì…˜ ===
function getMonday(){
  const j=new Date(yr,0,4),dw=j.getDay()||7,m=new Date(j);
  m.setDate(j.getDate()-dw+1+(wk-1)*7);
  return m;
}

function getISOWeeksInYear(y){
  const t=new Date(Date.UTC(y,11,28));
  t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7));
  const y1=new Date(Date.UTC(t.getUTCFullYear(),0,1));
  return Math.ceil((((t-y1)/864e5)+1)/7);
}

function navWeek(dir){
  if(dir<0){
    if(wk<=1){yr--;wk=getISOWeeksInYear(yr);}
    else wk--;
  }else{
    const mx=getISOWeeksInYear(yr);
    if(wk>=mx){yr++;wk=1;}else wk++;
  }
  loadWeek();renderInventory();renderAlerts();
}

function goToday(){
  const d=new Date(),t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7));
  yr=t.getUTCFullYear();
  const y1=new Date(Date.UTC(yr,0,1));
  wk=Math.ceil((((t-y1)/864e5)+1)/7);
  loadWeek();renderInventory();renderAlerts();
}

function getWeekDateRange(y,w){
  const j=new Date(y,0,4),dw=j.getDay()||7,m=new Date(j);
  m.setDate(j.getDate()-dw+1+(w-1)*7);
  const f=new Date(m);f.setDate(m.getDate()+4);
  return{mon:m,fri:f,text:(m.getMonth()+1)+'ì›” '+m.getDate()+'ì¼('+DOW_SHORT[m.getDay()]+') ~ '+(f.getMonth()+1)+'ì›” '+f.getDate()+'ì¼('+DOW_SHORT[f.getDay()]+')'};
}

function openWeekPicker(){
  const range=getWeekDateRange(yr,wk);
  let h='<div class="modal"><h2>ğŸ“† ì—°ë„/ì£¼ì°¨ ì´ë™</h2>';
  h+='<div class="form-row">';
  h+='<div><label>ì—°ë„</label><input type="number" id="pickYear" value="'+yr+'" min="2020" max="2040" oninput="updateWeekPreview()"></div>';
  h+='<div><label>ì£¼ì°¨ (1~'+getISOWeeksInYear(yr)+')</label><input type="number" id="pickWeek" value="'+wk+'" min="1" max="53" oninput="updateWeekPreview()"></div>';
  h+='</div>';
  h+='<div id="weekPreview" style="background:var(--blue-bg);color:var(--blue);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px;font-weight:600;text-align:center">ğŸ“… '+range.text+'</div>';
  h+='<div class="modal-btns">';
  h+='<button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>';
  h+='<button class="btn btn-outline" onclick="goToday();closeModal()">ì˜¤ëŠ˜ë¡œ</button>';
  h+='<button class="btn btn-blue" onclick="goToWeek()">ì´ë™</button>';
  h+='</div></div>';
  showModal(h);
  setTimeout(()=>document.getElementById('pickYear')?.focus(),50);
}

function updateWeekPreview(){
  const y=parseInt(document.getElementById('pickYear').value);
  const w=parseInt(document.getElementById('pickWeek').value);
  const el=document.getElementById('weekPreview');
  if(!el||!y||!w||y<2020||y>2040)return;
  const maxW=getISOWeeksInYear(y);
  if(w<1||w>maxW){el.textContent='âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ì°¨ (1~'+maxW+')';el.style.background='var(--orange-bg)';el.style.color='var(--orange)';return;}
  const range=getWeekDateRange(y,w);
  el.textContent='ğŸ“… '+range.text;el.style.background='var(--blue-bg)';el.style.color='var(--blue)';
}

function goToWeek(){
  const y=parseInt(document.getElementById('pickYear').value);
  const w=parseInt(document.getElementById('pickWeek').value);
  const maxW=getISOWeeksInYear(y);
  if(!y||y<2020||y>2040){toast('ì—°ë„ ë²”ìœ„: 2020~2040');return;}
  if(!w||w<1||w>maxW){toast('ì£¼ì°¨ ë²”ìœ„: 1~'+maxW);return;}
  yr=y;wk=w;
  closeModal();loadWeek();renderInventory();renderAlerts();
  toast(yr+'ë…„ìœ¼ë¡œ ì´ë™');
}

// === ì£¼ê°„ ë°ì´í„° ë¡œë“œ ===
function loadWeek(){
  const k='ws3_week_'+yr+'_'+wk,s=localStorage.getItem(k);
  if(s){
    days=JSON.parse(s);
    recalcNextId();
  }else{
    const m=getMonday();
    days=DAY_NAMES.map((n,i)=>{const dd=new Date(m);dd.setDate(m.getDate()+i);return{dn:n,dt:fmt(dd),tasks:[]};});
  }
  renderReport();
}

function fmt(d){return(d.getMonth()+1)+'/'+d.getDate();}
function fmtFull(d){return d.getFullYear()+'.'+(''+(d.getMonth()+1)).padStart(2,'0')+'.'+(''+(d.getDate())).padStart(2,'0');}

function getDayDate(di){
  const m=getMonday(),d=new Date(m);
  d.setDate(m.getDate()+di);
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}

// === ë³´ê³ ì„œ ë Œë”ë§ ===
function renderReport(){
  const m=getMonday(),f=new Date(m);f.setDate(m.getDate()+4);
  document.getElementById('ywText').textContent=yr+'ë…„ '+wk+'ì£¼ì°¨';
  document.getElementById('drText').textContent=(m.getMonth()+1)+'/'+m.getDate()+'('+DOW_SHORT[m.getDay()]+') ~ '+(f.getMonth()+1)+'/'+f.getDate()+'('+DOW_SHORT[f.getDay()]+')';
  document.getElementById('printDate').textContent=fmtFull(m)+' ~ '+fmtFull(f);

  let totalTasks=0,totalMats=0,usedProducts=new Set(),matUsage={};
  days.forEach(d=>{totalTasks+=d.tasks.length;d.tasks.forEach(t=>{totalMats+=t.mats.length;t.mats.forEach(x=>{usedProducts.add(x.pid);matUsage[x.pid]=(matUsage[x.pid]||0)+x.qty;});});});

  const topEntry=Object.entries(matUsage).sort((a,b)=>b[1]-a[1])[0];
  const topProduct=topEntry?productMap.get(parseInt(topEntry[0])):null;

  let h='<div class="card"><div class="summary">';
  h+='<div class="summary-item"><div class="val">'+totalTasks+'</div><div class="lbl">ì´ ì‘ì—…</div></div>';
  h+='<div class="sep"></div>';
  h+='<div class="summary-item"><div class="val blue">'+totalMats+'</div><div class="lbl">ìì¬ ì‚¬ìš©</div></div>';
  h+='<div class="sep"></div>';
  h+='<div class="summary-item"><div class="val">'+usedProducts.size+'</div><div class="lbl">ì‚¬ìš© í’ˆëª©</div></div>';
  if(topProduct){
    h+='<div class="sep"></div>';
    h+='<div class="summary-item"><div class="val small">'+topProduct.name+'</div><div class="lbl">ìµœë‹¤ ì‚¬ìš© (Ã—'+topEntry[1]+')</div></div>';
  }
  h+='</div></div>';

  days.forEach((d,di)=>{
    const dateKey=getDayDate(di);
    const isHoliday=!!holidays[dateKey];
    h+='<div class="day-header'+(isHoliday?' holiday':'')+'">';
    h+='<div class="left-part"><div class="day-dot"></div><h3>'+d.dn+'</h3><span class="date">'+d.dt+'</span>';
    if(isHoliday)h+='<span class="holiday-badge" onclick="removeHoliday(\''+dateKey+'\')">'+esc(holidays[dateKey])+' âœ•</span>';
    h+='</div>';
    h+='<div class="right-part">';
    if(!isHoliday)h+='<button class="holiday-btn" onclick="openHolidayInput('+di+',\''+dateKey+'\')">ğŸ“… ê³µíœ´ì¼</button>';
    h+='<button class="btn btn-ghost btn-sm" style="color:var(--blue)" onclick="addTask('+di+')">+ ì‘ì—… ì¶”ê°€</button>';
    h+='</div></div>';
    if(!d.tasks.length)h+='<p class="empty-msg">'+(isHoliday?'ê³µíœ´ì¼':'ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤')+'</p>';
    d.tasks.forEach((t,ti)=>{
      const hasMat=t.mats.length>0;
      h+='<div class="task'+(hasMat?' has-mat':'')+'">';
      h+='<div class="task-num">'+(ti+1)+'</div>';
      h+='<div class="task-body">';
      if(t.editing){
        h+='<div class="task-edit-area">';
        h+='<select onchange="changeBuilding('+di+','+ti+',this.value)">';
        h+='<option value="">ê±´ë¬¼ ì„ íƒ...</option>';
        buildings.forEach(b=>{h+='<option value="'+esc(b)+'"'+(t.building===b?' selected':'')+'>'+esc(b)+'</option>';});
        h+='<option value="__add__">+ ê±´ë¬¼ ì¶”ê°€...</option>';
        h+='<option value="__manage__">âš™ï¸ ê±´ë¬¼ ê´€ë¦¬...</option>';
        h+='</select>';
        h+='<input value="'+esc(t.desc)+'" onblur="finishEdit('+di+','+ti+',this)" onkeydown="if(event.key===\'Enter\')this.blur()" placeholder="ì‘ì—… ë‚´ìš© ì…ë ¥...">';
        h+='<input value="'+esc(t.note||'')+'" onblur="finishNote('+di+','+ti+',this)" onkeydown="if(event.key===\'Enter\')this.blur()" placeholder="ë¹„ê³  (ì„ íƒì‚¬í•­)">';
        h+='</div>';
      }else{
        if(t.building)h+='<span class="task-building">'+esc(t.building)+'</span> ';
        h+='<p class="'+(t.desc?'':'empty')+'" onclick="startEdit('+di+','+ti+')">'+(esc(t.desc)||'í´ë¦­í•˜ì—¬ ì‘ì—… ë‚´ìš© ì…ë ¥...')+'</p>';
        if(t.note)h+='<div class="task-note" onclick="startEdit('+di+','+ti+')">ğŸ“ '+esc(t.note)+'</div>';
      }
      if(hasMat){
        h+='<div class="mats">';
        t.mats.forEach(x=>{
          const p=productMap.get(x.pid);
          h+='<span class="mat-badge">'+esc(p?p.name:'ì•Œìˆ˜ì—†ìŒ')+' <span class="qty">Ã—'+x.qty+'</span>';
          h+='<span class="remove" onclick="removeMaterial('+di+','+ti+','+x.id+')">âœ•</span></span>';
        });
        h+='</div>';
      }
      h+='</div>';
      h+='<div class="task-actions">';
      h+='<button class="act-edit" onclick="startEdit('+di+','+ti+')" title="ìˆ˜ì •">âœï¸</button>';
      h+='<button class="act-add" onclick="openMaterialPicker('+di+','+ti+')" title="ìì¬ ì¶”ê°€">+</button>';
      h+='<button class="act-del" onclick="deleteTask('+di+','+ti+')" title="ì‚­ì œ">ğŸ—‘</button>';
      h+='</div></div>';
    });
  });
  document.getElementById('reportPanel').innerHTML=h;
}

// === ì‘ì—… ê´€ë¦¬ ===
function addTask(di){days[di].tasks.push({id:nextId++,desc:'',building:'',note:'',editing:true,mats:[]});saveWeek();renderReport();focusEditInput();}
function startEdit(di,ti){days[di].tasks[ti].editing=true;renderReport();focusEditInput();}
function finishEdit(di,ti,el){
  days[di].tasks[ti].desc=el.value.trim();saveWeek();
  setTimeout(()=>{const area=el.closest('.task-edit-area');if(!area||!area.contains(document.activeElement)){days[di].tasks[ti].editing=false;saveWeek();renderReport();}},50);
}
function finishNote(di,ti,el){
  days[di].tasks[ti].note=el.value.trim();saveWeek();
  setTimeout(()=>{const area=el.closest('.task-edit-area');if(!area||!area.contains(document.activeElement)){days[di].tasks[ti].editing=false;saveWeek();renderReport();}},50);
}
function changeBuilding(di,ti,val){
  if(val==='__add__'){const name=prompt('ìƒˆ ê±´ë¬¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');if(name&&name.trim()){const bn=name.trim();if(!buildings.includes(bn)){buildings.push(bn);saveBuildings();}days[di].tasks[ti].building=bn;}saveWeek();renderReport();focusEditInput();}
  else if(val==='__manage__'){openBuildingManager(di,ti);}
  else{days[di].tasks[ti].building=val;saveWeek();}
}

function openBuildingManager(returnDi,returnTi){
  function render(){
    let h='<div class="modal"><h2>ğŸ¢ ê±´ë¬¼ ê´€ë¦¬</h2>';
    h+='<div style="display:flex;gap:8px;margin-bottom:12px">';
    h+='<input id="newBldgName" placeholder="ìƒˆ ê±´ë¬¼ ì´ë¦„..." style="flex:1" onkeydown="if(event.key===\'Enter\')addBuildingFromManager()">';
    h+='<button class="btn btn-blue" onclick="addBuildingFromManager()">ì¶”ê°€</button>';
    h+='</div>';
    h+='<div class="modal-list" style="max-height:300px">';
    buildings.forEach((b,i)=>{
      h+='<div class="pm-row">';
      h+='<span class="pm-name" style="font-size:13px">'+esc(b)+'</span>';
      h+='<div class="pm-actions">';
      h+='<button onclick="editBuildingName('+i+')" title="ì´ë¦„ ë³€ê²½">âœï¸</button>';
      h+='<button class="del" onclick="deleteBuildingItem('+i+')" title="ì‚­ì œ">ğŸ—‘</button>';
      h+='</div></div>';
    });
    if(!buildings.length)h+='<p style="text-align:center;color:var(--gray-400);padding:20px">ë“±ë¡ëœ ê±´ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    h+='</div>';
    h+='<div style="margin-top:12px;text-align:right"><button class="btn btn-outline" onclick="closeModal();'+(returnDi!==undefined?'renderReport();focusEditInput()':'')+'" >ë‹«ê¸°</button></div>';
    h+='</div>';
    showModal(h);
  }
  window.addBuildingFromManager=()=>{
    const inp=document.getElementById('newBldgName');
    const name=inp.value.trim();
    if(!name){toast('ê±´ë¬¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
    if(buildings.includes(name)){toast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê±´ë¬¼ì…ë‹ˆë‹¤');return;}
    buildings.push(name);saveBuildings();render();
    toast(name+' ì¶”ê°€ë¨');
  };
  window.editBuildingName=(idx)=>{
    const oldName=buildings[idx];
    const newName=prompt('ê±´ë¬¼ ì´ë¦„ ë³€ê²½:',oldName);
    if(!newName||!newName.trim()||newName.trim()===oldName)return;
    const bn=newName.trim();
    if(buildings.includes(bn)){toast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê±´ë¬¼ì…ë‹ˆë‹¤');return;}
    // ê¸°ì¡´ ì‘ì—…ì˜ ê±´ë¬¼ëª…ë„ ì¼ê´„ ë³€ê²½
    let updated=0;
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(!k.startsWith('ws3_week_'))continue;
      try{
        const wd=JSON.parse(localStorage.getItem(k));
        let changed=false;
        wd.forEach(d=>d.tasks.forEach(t=>{if(t.building===oldName){t.building=bn;changed=true;updated++;}}));
        if(changed)localStorage.setItem(k,JSON.stringify(wd));
      }catch(e){}
    }
    buildings[idx]=bn;saveBuildings();
    // í˜„ì¬ ì£¼ê°„ ë°ì´í„°ë„ ê°±ì‹ 
    days.forEach(d=>d.tasks.forEach(t=>{if(t.building===oldName)t.building=bn;}));
    saveWeek();render();
    toast(oldName+' â†’ '+bn+' ë³€ê²½'+(updated?' (ì‘ì—… '+updated+'ê±´ ì—…ë°ì´íŠ¸)':''));
  };
  window.deleteBuildingItem=(idx)=>{
    const name=buildings[idx];
    if(!confirm('"'+name+'" ê±´ë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ì‘ì—…ì˜ ê±´ë¬¼ ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)'))return;
    buildings.splice(idx,1);saveBuildings();render();
    toast(name+' ì‚­ì œë¨');
  };
  render();
}
function focusEditInput(){setTimeout(()=>{const inp=document.querySelector('.task-edit-area input');if(inp){inp.focus();inp.selectionStart=inp.value.length;}},0);}
function deleteTask(di,ti){
  const t=days[di].tasks[ti];
  t.mats.forEach(m=>{const p=productMap.get(m.pid);if(p){p.stock+=m.qty;p.tout=Math.max(0,p.tout-m.qty);}});
  days[di].tasks.splice(ti,1);
  saveWeek();saveProducts();renderReport();renderInventory();renderAlerts();
  toast('ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// === ê³µíœ´ì¼ ê´€ë¦¬ ===
function openHolidayInput(di,dateKey){
  let h='<div class="modal"><h2>ğŸ“… ê³µíœ´ì¼ ì§€ì •</h2>';
  h+='<p style="font-size:13px;color:var(--gray-600);margin-bottom:12px">'+days[di].dn+' ('+days[di].dt+')ì„ ê³µíœ´ì¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤.</p>';
  h+='<label>ê³µíœ´ì¼ ì´ë¦„</label>';
  h+='<input id="holidayName" placeholder="ì˜ˆ: ì‚¼ì¼ì ˆ, ì–´ë¦°ì´ë‚ ..." onkeydown="if(event.key===\'Enter\')confirmHoliday(\''+dateKey+'\')">';
  h+='<div class="modal-btns">';
  h+='<button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>';
  h+='<button class="btn btn-blue" onclick="confirmHoliday(\''+dateKey+'\')">ì§€ì •</button>';
  h+='</div></div>';
  showModal(h);
  setTimeout(()=>document.getElementById('holidayName')?.focus(),50);
}

function confirmHoliday(dateKey){
  const name=(document.getElementById('holidayName').value.trim())||'ê³µíœ´ì¼';
  holidays[dateKey]=name;
  saveHolidays();closeModal();renderReport();
  toast(name+' ê³µíœ´ì¼ ì§€ì • ì™„ë£Œ');
}

function removeHoliday(dateKey){
  const name=holidays[dateKey]||'ê³µíœ´ì¼';
  delete holidays[dateKey];
  saveHolidays();renderReport();
  toast(name+' ê³µíœ´ì¼ í•´ì œ');
}

// === ìì¬ ê´€ë¦¬ (ì‘ì—… ë‚´ ì¶œê³ ) ===
function removeMaterial(di,ti,mid){
  const t=days[di].tasks[ti],m=t.mats.find(x=>x.id===mid);
  if(m){const p=productMap.get(m.pid);if(p){p.stock+=m.qty;p.tout=Math.max(0,p.tout-m.qty);}}
  t.mats=t.mats.filter(x=>x.id!==mid);
  saveWeek();saveProducts();renderReport();renderInventory();renderAlerts();
}

function openMaterialPicker(di,ti){
  let sel=null,sq='',qty=1;
  function render(){
    const fl=products.filter(p=>!sq||p.name.toLowerCase().includes(sq.toLowerCase())||p.code.toLowerCase().includes(sq.toLowerCase()));
    let h='<div class="modal"><h2>ğŸ“¦ ìì¬ ì„ íƒ (ì¶œê³ )</h2>';
    if(sel){
      h+='<div class="product-info"><span class="pi-code">'+sel.code+'</span><div class="pi-name">'+sel.name+'</div>';
      h+='<div class="pi-stock">í˜„ì¬ ì¬ê³ : <b>'+sel.stock+'</b> '+sel.unit+'</div></div>';
      h+='<label>ì‚¬ìš© ìˆ˜ëŸ‰</label>';
      h+='<input type="number" id="matQty" value="'+qty+'" min="1" max="'+sel.stock+'" onkeydown="if(event.key===\'Enter\')document.getElementById(\'matConfirmBtn\').click()">';
      h+='<div class="modal-btns"><button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>';
      h+='<button id="matConfirmBtn" class="btn btn-blue" onclick="confirmMaterial('+di+','+ti+','+sel.id+')">ì¶œê³  í™•ì¸</button></div>';
    }else{
      h+='<input placeholder="ìì¬ ê²€ìƒ‰..." value="'+esc(sq)+'" oninput="window._matSearch(this.value)">';
      h+='<div class="modal-list">';
      fl.forEach(p=>{
        const dis=p.stock===0;
        h+='<div class="modal-product'+(dis?' disabled':'')+'" '+(dis?'':'onclick="window._matSelect('+p.id+')"')+'>';
        h+='<span class="mp-code">'+p.code+'</span><span class="mp-name">'+p.name+'</span>';
        h+='<span class="mp-stock'+(p.stock===0?' zero':p.stock<=5?' low':'')+'">'+p.stock+'</span>';
        h+='<span class="mp-unit">'+p.unit+'</span></div>';
      });
      if(!fl.length)h+='<p style="text-align:center;color:var(--gray-400);padding:20px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>';
      h+='</div>';
    }
    h+='</div>';
    showModal(h);
  }
  window._matSearch=v=>{sq=v;render();};
  window._matSelect=id=>{sel=productMap.get(id);qty=1;render();setTimeout(()=>document.getElementById('matQty')?.focus(),50);};
  window.confirmMaterial=(_di,_ti,pid)=>{
    const p=productMap.get(pid);
    if(!p||p.stock<=0){toast('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
    const q=clamp(parseInt(document.getElementById('matQty').value)||1,1,p.stock);
    days[_di].tasks[_ti].mats.push({id:nextId++,pid:pid,qty:q});
    p.stock-=q;p.tout+=q;
    addHistory('out',pid,q,'ì‘ì—…: '+(days[_di].tasks[_ti].desc||'(ë¯¸ì…ë ¥)'));
    closeModal();saveWeek();saveProducts();saveHistory();renderReport();renderInventory();renderAlerts();
    toast(p.name+' '+q+p.unit+' ì¶œê³  ì™„ë£Œ');
  };
  render();
}

// === í’ˆëª© ê´€ë¦¬ (CRUD) ===
function openProductManager(){
  let sq='';
  function render(){
    const fl=products.filter(p=>!sq||p.name.toLowerCase().includes(sq.toLowerCase())||p.code.toLowerCase().includes(sq.toLowerCase()));
    let h='<div class="modal wide"><h2>âš™ï¸ í’ˆëª© ê´€ë¦¬ <span style="font-size:12px;font-weight:400;color:var(--gray-500);margin-left:auto">ì´ '+products.length+'ê°œ</span></h2>';
    h+='<div style="display:flex;gap:8px;margin-bottom:12px">';
    h+='<input style="flex:1" placeholder="í’ˆëª© ê²€ìƒ‰..." value="'+esc(sq)+'" oninput="window._pmSearch(this.value)">';
    h+='<button class="btn btn-blue" onclick="openProductForm(null)">+ ìƒˆ í’ˆëª©</button>';
    h+='</div>';
    h+='<div class="modal-list" style="max-height:350px">';
    fl.forEach(p=>{
      h+='<div class="pm-row">';
      h+='<span class="pm-code">'+p.code+'</span>';
      h+='<span class="pm-name">'+esc(p.name)+'</span>';
      h+='<span style="font-size:10px;color:var(--gray-400)">'+(p.cat==='A'?'ì² ë¬¼':'ëª©ì¬')+'</span>';
      h+='<span class="pm-stock'+(p.stock===0?' zero':p.stock<=5?' low':'')+'">'+p.stock+'</span>';
      h+='<span class="pm-unit">'+p.unit+'</span>';
      h+='<div class="pm-actions">';
      h+='<button onclick="openProductForm('+p.id+')" title="ìˆ˜ì •">âœï¸</button>';
      h+='<button class="del" onclick="deleteProduct('+p.id+')" title="ì‚­ì œ">ğŸ—‘</button>';
      h+='</div></div>';
    });
    if(!fl.length)h+='<p style="text-align:center;color:var(--gray-400);padding:20px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>';
    h+='</div>';
    h+='<div style="margin-top:12px;text-align:right"><button class="btn btn-outline" onclick="closeModal()">ë‹«ê¸°</button></div>';
    h+='</div>';
    showModal(h);
  }
  window._pmSearch=v=>{sq=v;render();};
  render();
}

function openProductForm(pid,fromList){
  const p=pid?productMap.get(pid):null;
  const isEdit=!!p;
  window._formFromList=!!fromList;
  let h='<div class="modal"><h2>'+(isEdit?'âœï¸ í’ˆëª© ìˆ˜ì •':'â• ìƒˆ í’ˆëª© ì¶”ê°€')+'</h2>';
  h+='<div class="form-row"><div><label>í’ˆëª©ì½”ë“œ</label><input id="pCode" value="'+esc(p?p.code:'')+'" placeholder="ì˜ˆ: A31"></div>';
  h+='<div><label>ë¶„ë¥˜</label><select id="pCat"><option value="A"'+(p&&p.cat==='A'?' selected':(!p?' selected':''))+'>A - ì² ë¬¼</option><option value="B"'+(p&&p.cat==='B'?' selected':'')+'>B - ëª©ì¬</option></select></div></div>';
  h+='<label>í’ˆëª©ëª…</label><input id="pName" value="'+esc(p?p.name:'')+'" placeholder="í’ˆëª© ì´ë¦„...">';
  h+='<div class="form-row"><div><label>ë‹¨ìœ„</label><input id="pUnit" value="'+esc(p?p.unit:'ê°œ')+'" placeholder="ê°œ, ì¥, kg"></div>';
  h+='<div><label>'+(isEdit?'í˜„ì¬ê³ ':'ì´ˆê¸° ì¬ê³ ')+'</label><input type="number" id="pStock" value="'+(p?p.stock:0)+'" min="0"></div></div>';
  if(isEdit){
    h+='<div class="form-row"><div><label>ì´ ì…ê³ </label><input type="number" value="'+p.tin+'" disabled style="background:var(--gray-100)"></div>';
    h+='<div><label>ì´ ì¶œê³ </label><input type="number" value="'+p.tout+'" disabled style="background:var(--gray-100)"></div></div>';
  }
  h+='<div class="modal-btns">';
  h+='<button class="btn btn-outline" onclick="'+(fromList?'closeModal()':'openProductManager()')+'">ë’¤ë¡œ</button>';
  h+='<button class="btn btn-blue" onclick="saveProduct('+(pid||'null')+')">'+(isEdit?'ì €ì¥':'ì¶”ê°€')+'</button>';
  h+='</div></div>';
  showModal(h);
  setTimeout(()=>document.getElementById('pCode')?.focus(),50);
}

function saveProduct(pid){
  const code=document.getElementById('pCode').value.trim();
  const name=document.getElementById('pName').value.trim();
  const cat=document.getElementById('pCat').value;
  const unit=document.getElementById('pUnit').value.trim()||'ê°œ';
  const stock=Math.max(0,parseInt(document.getElementById('pStock').value)||0);
  if(!code||!name){toast('í’ˆëª©ì½”ë“œì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  // ì½”ë“œ ì¤‘ë³µ ì²´í¬
  const dup=products.find(x=>x.code===code&&x.id!==pid);
  if(dup){toast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í’ˆëª©ì½”ë“œì…ë‹ˆë‹¤: '+code);return;}

  if(pid){
    const p=productMap.get(pid);
    if(p){
      const oldStock=p.stock;
      p.code=code;p.name=name;p.cat=cat;p.unit=unit;p.stock=stock;
      if(stock!==oldStock){
        const diff=stock-oldStock;
        if(diff>0){p.tin+=diff;}else{p.tout+=Math.abs(diff);}
        addHistory(diff>0?'in':'out',pid,Math.abs(diff),'ì¬ê³  ìˆ˜ë™ ì¡°ì • ('+oldStock+' â†’ '+stock+')');
      }
    }
    toast(name+' ìˆ˜ì • ì™„ë£Œ');
  }else{
    products.push({id:nextId++,code,name,cat,unit,stock,tin:stock,tout:0});
    toast(name+' ì¶”ê°€ ì™„ë£Œ');
  }
  saveProducts();saveHistory();renderInventory();renderAlerts();
  if(window._formFromList){closeModal();window._formFromList=false;}else{openProductManager();}
}

function deleteProduct(pid){
  const p=productMap.get(pid);
  if(!p)return;
  let inUse=false;
  days.forEach(d=>d.tasks.forEach(t=>t.mats.forEach(m=>{if(m.pid===pid)inUse=true;})));
  let msg='"'+p.name+'" í’ˆëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
  if(inUse)msg+='\nâš ï¸ í˜„ì¬ ì£¼ê°„ ë³´ê³ ì„œì—ì„œ ì‚¬ìš© ì¤‘ì¸ í’ˆëª©ì…ë‹ˆë‹¤.';
  if(!confirm(msg))return;
  products=products.filter(x=>x.id!==pid);
  saveProducts();renderInventory();renderAlerts();
  openProductManager();
  toast(p.name+' ì‚­ì œ ì™„ë£Œ');
}

// === ì¬ê³  íŒ¨ë„ ===
function renderFilterBar(){
  let h='';
  // ì¬ê³  ìƒíƒœ í•„í„°
  const stockFilters=[['all','ì „ì²´'],['low','ë¶€ì¡± (â‰¤5)'],['zero','ì†Œì§„']];
  h+=stockFilters.map(f=>'<button class="'+(filter===f[0]?'active':'')+'" onclick="filter=\''+f[0]+'\';renderFilterBar();renderInventory()">'+f[1]+'</button>').join('');
  h+='<span class="filter-sep"></span>';
  // ì¹´í…Œê³ ë¦¬ í•„í„°
  const catFilters=[['all','ì „ì²´'],['A','ì² ë¬¼'],['B','ëª©ì¬']];
  h+=catFilters.map(f=>'<button class="'+(catFilter===f[0]?'active':'')+'" onclick="catFilter=\''+f[0]+'\';renderFilterBar();renderInventory()">'+f[1]+'</button>').join('');
  document.getElementById('filterBar').innerHTML=h;
}

function renderInventory(){
  const q=(document.getElementById('searchInput')?.value||'').toLowerCase();
  // ì£¼ê°„ ì‚¬ìš©ëŸ‰ ê³„ì‚°
  const weekUsage={};
  days.forEach(d=>d.tasks.forEach(t=>t.mats.forEach(m=>{weekUsage[m.pid]=(weekUsage[m.pid]||0)+m.qty;})));

  const list=products.filter(p=>{
    if(q&&!p.name.toLowerCase().includes(q)&&!p.code.toLowerCase().includes(q))return false;
    if(catFilter!=='all'&&p.cat!==catFilter)return false;
    if(filter==='zero')return p.stock===0;
    if(filter==='low')return p.stock>0&&p.stock<=5;
    return true;
  });

  if(!list.length){
    document.getElementById('invList').innerHTML='<p style="text-align:center;color:var(--gray-400);padding:40px 0;font-size:13px">'+(q?'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤':'í•´ë‹¹í•˜ëŠ” í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤')+'</p>';
    return;
  }

  document.getElementById('invList').innerHTML=list.map(p=>{
    const wu=weekUsage[p.id]||0;
    let h='<div class="inv-item" onclick="openProductForm('+p.id+',true)">';
    h+='<span class="code">'+p.code+'</span>';
    h+='<div class="info"><div class="name">'+esc(p.name)+'</div>';
    h+='<div class="sub">ì…ê³  '+p.tin+' Â· ì¶œê³  '+p.tout+(wu?' Â· <b style="color:var(--blue)">ê¸ˆì£¼ -'+wu+'</b>':'')+'</div></div>';
    if(wu)h+='<span class="change-badge dn">-'+wu+'</span>';
    h+='<span class="stock'+(p.stock===0?' zero':p.stock<=5?' low':'')+'">'+p.stock+'</span>';
    h+='<span class="unit">'+p.unit+'</span></div>';
    return h;
  }).join('');
}

// === ì•Œë¦¼ ë°” ===
function renderAlerts(){
  const lowStock=products.filter(p=>p.stock>0&&p.stock<=5);
  const zeroStock=products.filter(p=>p.stock===0&&(p.tin>0||p.tout>0));
  const bar=document.getElementById('alertBar');
  if(!lowStock.length&&!zeroStock.length){bar.style.display='none';return;}
  let h='âš ï¸ ';
  if(zeroStock.length)h+='ì¬ê³  ì†Œì§„ <b>'+zeroStock.length+'</b>ê°œ ';
  if(lowStock.length)h+='ë¶€ì¡± ì¬ê³  <b>'+lowStock.length+'</b>ê°œ (â‰¤5) ';
  h+='<button class="btn btn-ghost btn-sm" style="color:#92400E;text-decoration:underline" onclick="filter=\'low\';catFilter=\'all\';renderFilterBar();renderInventory();switchTab(\'stock\')">í™•ì¸ â†’</button>';
  h+='<span class="alert-close" onclick="this.parentElement.style.display=\'none\'">âœ•</span>';
  bar.innerHTML=h;bar.style.display='flex';
}

// === íƒ­ ì „í™˜ ===
function switchTab(tab){
  currentTab=tab;
  document.getElementById('tabStock').className=tab==='stock'?'active':'';
  document.getElementById('tabHistory').className=tab==='history'?'active':'';
  document.getElementById('tabTasks').className=tab==='tasks'?'active':'';
  document.getElementById('stockView').style.display=tab==='stock'?'flex':'none';
  document.getElementById('historyView').style.display=tab==='history'?'block':'none';
  document.getElementById('tasksView').style.display=tab==='tasks'?'flex':'none';
  if(tab==='history')renderHistory();
  if(tab==='tasks')renderTaskHistory();
}

function renderHistory(){
  if(!history.length){
    document.getElementById('historyView').innerHTML='<p style="text-align:center;color:var(--gray-400);padding:40px 0;font-size:13px">ì…ì¶œê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    return;
  }
  const sorted=[...history].reverse();
  document.getElementById('historyView').innerHTML=sorted.map(h=>{
    const p=productMap.get(h.pid);
    let html='<div class="history-item">';
    const typeMap={in:['in','ì…ê³ '],out:['out','ì¶œê³ '],adj:['adj','ì¡°ì •']};
    const [tcls,tlbl]=typeMap[h.type]||['out','ì¶œê³ '];
    html+='<span class="h-badge '+tcls+'">'+tlbl+'</span>';
    html+='<div class="h-info"><div class="h-name">'+(p?esc(p.name):'ì‚­ì œëœ í’ˆëª©')+'</div>';
    html+='<div class="h-sub">'+h.date+(h.memo?' Â· '+esc(h.memo):'')+'</div></div>';
    if(h.type==='adj')html+='<span class="h-qty" style="color:var(--orange)">ì¡°ì •</span>';
    else html+='<span class="h-qty" style="color:'+(h.type==='in'?'var(--green)':'var(--red)')+'">'+(h.type==='in'?'+':'-')+h.qty+'</span>';
    html+='</div>';
    return html;
  }).join('');
}

function addHistory(type,pid,qty,memo){
  const d=new Date();
  const dateStr=d.getFullYear()+'.'+(''+(d.getMonth()+1)).padStart(2,'0')+'.'+(''+(d.getDate())).padStart(2,'0');
  history.push({type,pid,qty,memo:memo||'',date:dateStr});
  saveHistory();
}

// === ì…ê³  ëª¨ë‹¬ ===
function openInbound(){
  let sel=null,sq='',qty=1,memo='';
  function render(){
    const fl=products.filter(p=>!sq||p.name.toLowerCase().includes(sq.toLowerCase())||p.code.toLowerCase().includes(sq.toLowerCase()));
    let h='<div class="modal"><h2>ğŸ“¦ ì…ê³  ë“±ë¡</h2>';
    if(sel){
      h+='<div class="product-info"><span class="pi-code">'+sel.code+'</span><div class="pi-name">'+esc(sel.name)+'</div>';
      h+='<div class="pi-stock">í˜„ì¬ ì¬ê³ : <b>'+sel.stock+'</b> '+sel.unit+'</div></div>';
      h+='<label>ì…ê³  ìˆ˜ëŸ‰</label><input type="number" id="inQty" value="'+qty+'" min="1">';
      h+='<label>ë©”ëª¨ (ì„ íƒ)</label><input id="inMemo" value="'+esc(memo)+'" placeholder="ì…ê³  ì‚¬ìœ ...">';
      h+='<div class="modal-btns"><button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>';
      h+='<button class="btn btn-green" onclick="confirmInbound('+sel.id+')">ì…ê³  ì²˜ë¦¬</button></div>';
    }else{
      h+='<input placeholder="ìƒí’ˆ ê²€ìƒ‰..." value="'+esc(sq)+'" oninput="window._inSearch(this.value)">';
      h+='<div class="modal-list">';
      fl.forEach(p=>{
        h+='<div class="modal-product" onclick="window._inSelect('+p.id+')">';
        h+='<span class="mp-code">'+p.code+'</span><span class="mp-name">'+esc(p.name)+'</span>';
        h+='<span class="mp-stock">'+p.stock+'</span><span class="mp-unit">'+p.unit+'</span></div>';
      });
      if(!fl.length)h+='<p style="text-align:center;color:var(--gray-400);padding:20px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>';
      h+='</div>';
    }
    h+='</div>';
    showModal(h);
  }
  window._inSearch=v=>{sq=v;render();};
  window._inSelect=id=>{sel=productMap.get(id);qty=1;render();setTimeout(()=>document.getElementById('inQty')?.focus(),50);};
  window.confirmInbound=pid=>{
    const q=Math.max(1,parseInt(document.getElementById('inQty').value)||1);
    const m=document.getElementById('inMemo').value.trim();
    const p=productMap.get(pid);
    if(p){p.stock+=q;p.tin+=q;}
    addHistory('in',pid,q,m);
    closeModal();saveProducts();saveHistory();renderInventory();renderAlerts();
    toast(p.name+' '+q+p.unit+' ì…ê³  ì™„ë£Œ');
  };
  render();
}

// === ì¶œê³  ëª¨ë‹¬ (ë…ë¦½) ===
function openOutbound(){
  let sel=null,sq='',qty=1,memo='';
  function render(){
    const fl=products.filter(p=>!sq||p.name.toLowerCase().includes(sq.toLowerCase())||p.code.toLowerCase().includes(sq.toLowerCase()));
    let h='<div class="modal"><h2>ğŸ“¤ ì¶œê³  ë“±ë¡</h2>';
    if(sel){
      h+='<div class="product-info"><span class="pi-code">'+sel.code+'</span><div class="pi-name">'+esc(sel.name)+'</div>';
      h+='<div class="pi-stock">í˜„ì¬ ì¬ê³ : <b>'+sel.stock+'</b> '+sel.unit+'</div></div>';
      h+='<label>ì¶œê³  ìˆ˜ëŸ‰</label><input type="number" id="outQty" value="'+qty+'" min="1" max="'+sel.stock+'">';
      h+='<label>ì‚¬ìœ  (ì„ íƒ)</label><input id="outMemo" value="'+esc(memo)+'" placeholder="ì¶œê³  ì‚¬ìœ ...">';
      h+='<div class="modal-btns"><button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>';
      h+='<button style="background:var(--red);color:#fff" onclick="confirmOutbound('+sel.id+')">ì¶œê³  ì²˜ë¦¬</button></div>';
    }else{
      h+='<input placeholder="ìƒí’ˆ ê²€ìƒ‰..." value="'+esc(sq)+'" oninput="window._outSearch(this.value)">';
      h+='<div class="modal-list">';
      fl.forEach(p=>{
        const dis=p.stock===0;
        h+='<div class="modal-product'+(dis?' disabled':'')+'" '+(dis?'':'onclick="window._outSelect('+p.id+')"')+'>';
        h+='<span class="mp-code">'+p.code+'</span><span class="mp-name">'+esc(p.name)+'</span>';
        h+='<span class="mp-stock'+(p.stock===0?' zero':p.stock<=5?' low':'')+'">'+p.stock+'</span>';
        h+='<span class="mp-unit">'+p.unit+'</span></div>';
      });
      if(!fl.length)h+='<p style="text-align:center;color:var(--gray-400);padding:20px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>';
      h+='</div>';
    }
    h+='</div>';
    showModal(h);
  }
  window._outSearch=v=>{sq=v;render();};
  window._outSelect=id=>{sel=productMap.get(id);qty=1;render();setTimeout(()=>document.getElementById('outQty')?.focus(),50);};
  window.confirmOutbound=pid=>{
    const p=productMap.get(pid);
    if(!p||p.stock<=0){toast('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
    const q=clamp(parseInt(document.getElementById('outQty').value)||1,1,p.stock);
    const m=document.getElementById('outMemo').value.trim();
    p.stock-=q;p.tout+=q;
    addHistory('out',pid,q,m);
    closeModal();saveProducts();saveHistory();renderInventory();renderAlerts();
    toast(p.name+' '+q+p.unit+' ì¶œê³  ì™„ë£Œ');
  };
  render();
}

// === ëª¨ë‹¬ ìœ í‹¸ë¦¬í‹° ===
function showModal(content){
  document.body.style.overflow='hidden';
  document.getElementById('modalRoot').innerHTML='<div class="modal-overlay" role="dialog" aria-modal="true" onclick="if(event.target===this)closeModal()">'+content+'</div>';
}
function closeModal(){
  document.body.style.overflow='';
  document.getElementById('modalRoot').innerHTML='';
  delete window._matSearch;delete window._matSelect;delete window.confirmMaterial;
  delete window._inSearch;delete window._inSelect;delete window.confirmInbound;
  delete window._outSearch;delete window._outSelect;delete window.confirmOutbound;
  delete window._pmSearch;
}
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&document.getElementById('modalRoot').innerHTML)closeModal();});

// === ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ===
function exportData(){
  const allWeeks={};
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k.startsWith('ws3_week_'))allWeeks[k]=JSON.parse(localStorage.getItem(k));
  }
  const data={version:5,exportDate:new Date().toISOString(),products,history,holidays,buildings,weeks:allWeeks};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='woodshop_backup_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();setTimeout(()=>URL.revokeObjectURL(a.href),100);
  toast('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function importData(event){
  const file=event.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.products)throw new Error('ì˜ëª»ëœ í˜•ì‹');
      if(!confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'))return;
      products=data.products;saveProducts();
      if(data.history){history=data.history;saveHistory();}
      if(data.holidays){holidays=data.holidays;saveHolidays();}
      if(data.buildings){buildings=data.buildings;saveBuildings();}
      if(data.weeks){Object.entries(data.weeks).forEach(([k,v])=>localStorage.setItem(k,JSON.stringify(v)));}
      recalcNextId();loadWeek();renderInventory();renderFilterBar();renderAlerts();
      toast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
    }catch(err){alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+err.message);}
  };
  reader.readAsText(file);
  event.target.value='';
}

function csvEsc(s){return '"'+String(s||'').replace(/"/g,'""')+'"';}
function exportCSV(){
  let csv='\uFEFFì½”ë“œ,í’ˆëª©ëª…,ë¶„ë¥˜,ë‹¨ìœ„,í˜„ì¬ê³ ,ì´ì…ê³ ,ì´ì¶œê³ \n';
  products.forEach(p=>{
    csv+=csvEsc(p.code)+','+csvEsc(p.name)+','+csvEsc(p.cat==='A'?'ì² ë¬¼':'ëª©ì¬')+','+csvEsc(p.unit)+','+p.stock+','+p.tin+','+p.tout+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='inventory_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();setTimeout(()=>URL.revokeObjectURL(a.href),100);
  toast('CSV íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// === ì¸ì‡„ ===
function printReport(){
  const matMap={};
  days.forEach(d=>d.tasks.forEach(t=>t.mats.forEach(m=>{
    if(!matMap[m.pid])matMap[m.pid]=0;
    matMap[m.pid]+=m.qty;
  })));
  const matEntries=Object.entries(matMap);
  if(matEntries.length){
    let sh='<h2>ìì¬ ì‚¬ìš© ìš”ì•½</h2><table><tr><th>í’ˆëª©ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ì‚¬ìš©ëŸ‰</th><th>ë‹¨ìœ„</th></tr>';
    matEntries.forEach(([pid,qty])=>{
      const p=productMap.get(parseInt(pid));
      if(p)sh+='<tr><td>'+p.code+'</td><td>'+esc(p.name)+'</td><td class="num">'+qty+'</td><td>'+p.unit+'</td></tr>';
    });
    sh+='</table>';
    document.getElementById('printSummary').innerHTML=sh;
  }else{document.getElementById('printSummary').innerHTML='';}

  let ih='<h2>ì¬ê³  í˜„í™©</h2><table><tr><th>ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ë¶„ë¥˜</th><th>í˜„ì¬ê³ </th><th>ë‹¨ìœ„</th></tr>';
  products.filter(p=>p.stock>0||p.tin>0||p.tout>0).forEach(p=>{
    ih+='<tr><td>'+p.code+'</td><td>'+esc(p.name)+'</td><td>'+(p.cat==='A'?'ì² ë¬¼':'ëª©ì¬')+'</td>';
    ih+='<td class="num">'+p.stock+'</td><td>'+p.unit+'</td></tr>';
  });
  ih+='</table>';
  document.getElementById('printInventory').innerHTML=ih;
  window.print();
}

// === ìœ í‹¸ë¦¬í‹° ===
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function clamp(v,min,max){return Math.max(min,Math.min(v,max));}
function toast(msg){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div');
  el.className='toast';el.setAttribute('role','status');el.setAttribute('aria-live','polite');
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),300);},2000);
}

// === ìƒˆë¡œê³ ì¹¨ ===
async function refreshAll(){
  if(SCRIPT_URL){
    updateSyncStatus('syncing');
    const ok=await loadFromCloud();
    if(ok)updateSyncStatus('synced');
    else updateSyncStatus('error');
  }
  loadProducts();loadHistory();loadHolidays();loadBuildings();
  loadWeek();renderFilterBar();renderInventory();renderAlerts();
  if(currentTab==='history')renderHistory();
  if(currentTab==='tasks')renderTaskHistory();
  toast(SCRIPT_URL?'í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ':'ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}

// === ì‘ì—… ì´ë ¥ ===
function getMondayOf(y,w){
  const j=new Date(y,0,4),dw=j.getDay()||7,m=new Date(j);
  m.setDate(j.getDate()-dw+1+(w-1)*7);
  return m;
}

function loadAllTasks(year,month){
  const tasks=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(!k.startsWith('ws3_week_'))continue;
    const pts=k.replace('ws3_week_','').split('_');
    const wy=parseInt(pts[0]),ww=parseInt(pts[1]);
    const mon=getMondayOf(wy,ww);
    let wd;try{wd=JSON.parse(localStorage.getItem(k));}catch(e){continue;}
    if(!Array.isArray(wd))continue;
    wd.forEach((d,di)=>{
      const dd=new Date(mon);dd.setDate(mon.getDate()+di);
      if(dd.getFullYear()!==year)return;
      if(month&&dd.getMonth()+1!==month)return;
      d.tasks.forEach(t=>{
        tasks.push({date:dd,dateStr:dd.getFullYear()+'.'+(''+(dd.getMonth()+1)).padStart(2,'0')+'.'+(''+(dd.getDate())).padStart(2,'0'),dow:DOW_SHORT[dd.getDay()],building:t.building||'',desc:t.desc||'',note:t.note||'',mats:t.mats||[]});
      });
    });
  }
  tasks.sort((a,b)=>a.date-b.date);
  return tasks;
}

function renderTaskHistory(){
  let h='<div class="th-nav">';
  h+='<button class="btn btn-ghost btn-sm" onclick="navTH(-1)">â—€</button>';
  h+='<span class="th-label">'+(thMode==='month'?thYear+'ë…„ '+thMonth+'ì›”':thYear+'ë…„')+'</span>';
  h+='<button class="btn btn-ghost btn-sm" onclick="navTH(1)">â–¶</button>';
  h+='</div>';
  h+='<div class="th-mode">';
  h+='<button class="'+(thMode==='month'?'active':'')+'" onclick="thMode=\'month\';renderTaskHistory()">ì›”ë³„</button>';
  h+='<button class="'+(thMode==='year'?'active':'')+'" onclick="thMode=\'year\';renderTaskHistory()">ì—°ë„ë³„</button>';
  h+='</div>';
  h+='<div class="th-list">';
  if(thMode==='month'){
    const tasks=loadAllTasks(thYear,thMonth);
    if(!tasks.length){h+='<p class="th-empty">ì´ ê¸°ê°„ì˜ ì‘ì—… ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</p>';}
    else{
      let ld='';
      tasks.forEach(t=>{
        if(t.dateStr!==ld){ld=t.dateStr;h+='<div class="th-day-hdr">'+t.dateStr+' ('+t.dow+')</div>';}
        h+='<div class="th-task">';
        if(t.building)h+='<span class="th-bld">'+esc(t.building)+'</span>';
        h+='<div><div class="th-desc">'+(esc(t.desc)||'<span style="color:var(--gray-400)">(ë‚´ìš© ì—†ìŒ)</span>')+'</div>';
        if(t.mats.length){const mn=t.mats.map(m=>{const p=productMap.get(m.pid);return(p?p.name:'?')+'\u00d7'+m.qty;});h+='<div class="th-mats">\ud83d\udce6 '+esc(mn.join(', '))+'</div>';}
        if(t.note)h+='<div class="th-mats">\ud83d\udcdd '+esc(t.note)+'</div>';
        h+='</div></div>';
      });
    }
  }else{
    const all=loadAllTasks(thYear);
    if(!all.length){h+='<p class="th-empty">'+thYear+'ë…„ ì‘ì—… ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</p>';}
    else{
      const byM={};
      all.forEach(t=>{const m=t.date.getMonth()+1;if(!byM[m])byM[m]=[];byM[m].push(t);});
      for(let m=1;m<=12;m++){
        if(!byM[m])continue;
        let mc=0;byM[m].forEach(t=>{mc+=t.mats.length;});
        h+='<div class="th-month-card" onclick="thMode=\'month\';thMonth='+m+';renderTaskHistory()">';
        h+='<div class="th-mc-title">'+m+'ì›”</div>';
        h+='<div class="th-mc-stats"><span>ì‘ì—… <b>'+byM[m].length+'</b>ê±´</span><span>ìì¬ì‚¬ìš© <b>'+mc+'</b>ê±´</span></div></div>';
      }
    }
  }
  h+='</div>';
  document.getElementById('tasksView').innerHTML=h;
}

function navTH(dir){
  if(thMode==='month'){thMonth+=dir;if(thMonth<1){thMonth=12;thYear--;}if(thMonth>12){thMonth=1;thYear++;}}
  else{thYear+=dir;}
  renderTaskHistory();
}

// === í´ë¼ìš°ë“œ ì—°ë™ (form POST ì €ì¥ + ë‹¤ì¤‘ ì½ê¸°) ===
function formPost(data){
  const id='_fp'+Date.now();
  const iframe=document.createElement('iframe');iframe.name=id;iframe.style.display='none';
  document.body.appendChild(iframe);
  const form=document.createElement('form');form.method='POST';form.action=SCRIPT_URL;form.target=id;
  const input=document.createElement('input');input.type='hidden';input.name='data';input.value=JSON.stringify(data);
  form.appendChild(input);document.body.appendChild(form);form.submit();
  setTimeout(()=>{try{form.remove();iframe.remove();}catch(e){}},5000);
}
function queueCloudSave(key,value){
  if(!SCRIPT_URL)return;
  _cloudQueue[key]=value;
  clearTimeout(_cloudTimer);
  _cloudTimer=setTimeout(flushCloudQueue,2000);
}
function flushCloudQueue(){
  const keys=Object.keys(_cloudQueue);
  if(!SCRIPT_URL||!keys.length)return;
  const items=keys.map(k=>({key:k,value:_cloudQueue[k]}));
  _cloudQueue={};
  updateSyncStatus('syncing');
  formPost({action:'saveMultiple',items});
  setTimeout(()=>updateSyncStatus('synced'),3000);
}
async function tryFetch(url,ms){
  const c=new AbortController();const t=setTimeout(()=>c.abort(),ms||8000);
  try{const r=await fetch(url,{signal:c.signal,redirect:'follow'});clearTimeout(t);return await r.json();}
  catch(e){clearTimeout(t);return null;}
}
function applyCloudData(d){
  if(!d||!Object.keys(d).length)return false;
  Object.entries(d).forEach(([k,v])=>{
    try{localStorage.setItem('ws3_'+k,typeof v==='string'?v:JSON.stringify(v));}catch(e){}
  });
  return true;
}
function tryJsonp(url,ms){
  return new Promise(resolve=>{
    const cb='_jp'+Date.now();
    const tm=setTimeout(()=>{cleanup();resolve(null);},ms||8000);
    function cleanup(){clearTimeout(tm);delete window[cb];try{s.remove();}catch(e){}}
    window[cb]=function(data){cleanup();resolve(data);};
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    s.onerror=()=>{cleanup();resolve(null);};
    document.head.appendChild(s);
  });
}
async function loadFromCloud(){
  if(!SCRIPT_URL)return false;
  const url=SCRIPT_URL+'?action=loadAll';
  // ë°©ë²•1: ì§ì ‘ fetch
  let json=await tryFetch(url,6000);
  if(json&&json.success)return applyCloudData(json.data);
  // ë°©ë²•2: JSONP
  json=await tryJsonp(url,6000);
  if(json&&json.success)return applyCloudData(json.data);
  // ë°©ë²•3: CORS í”„ë¡ì‹œ (allorigins)
  json=await tryFetch('https://api.allorigins.win/raw?url='+encodeURIComponent(url),6000);
  if(json&&json.success)return applyCloudData(json.data);
  // ë°©ë²•4: CORS í”„ë¡ì‹œ (corsproxy)
  json=await tryFetch('https://corsproxy.io/?'+encodeURIComponent(url),6000);
  if(json&&json.success)return applyCloudData(json.data);
  return false;
}
async function uploadAllToCloud(){
  if(!SCRIPT_URL){toast('í´ë¼ìš°ë“œ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');return;}
  updateSyncStatus('syncing');
  const items=[];
  items.push({key:'products',value:JSON.stringify(products)});
  items.push({key:'history',value:JSON.stringify(history)});
  items.push({key:'holidays',value:JSON.stringify(holidays)});
  items.push({key:'buildings',value:JSON.stringify(buildings)});
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k&&k.startsWith('ws3_week_'))items.push({key:k.replace('ws3_',''),value:localStorage.getItem(k)});
  }
  formPost({action:'saveMultiple',items});
  setTimeout(()=>{updateSyncStatus('synced');toast('ğŸ“¤ ì—…ë¡œë“œ ìš”ì²­ ì™„ë£Œ ('+items.length+'ê°œ í•­ëª©). ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.');},3000);
}
function updateSyncStatus(s){
  const el=document.getElementById('syncStatus');if(!el)return;
  if(s==='syncing'){el.textContent='ğŸ”„';el.title='ë™ê¸°í™” ì¤‘...';}
  else if(s==='synced'){el.textContent='âœ…';el.title='í´ë¼ìš°ë“œ ì—°ê²°ë¨';}
  else if(s==='error'){el.textContent='âš ï¸';el.title='ë™ê¸°í™” ì˜¤ë¥˜';}
  else{el.textContent='â˜ï¸';el.title='í´ë¼ìš°ë“œ ëŒ€ê¸°';}
}
function openCloudSettings(){
  let h='<div class="modal" style="max-width:480px"><h2>â˜ï¸ í´ë¼ìš°ë“œ ì„¤ì •</h2>';
  h+='<p style="font-size:13px;color:var(--gray-600);margin-bottom:16px">Google Sheetsë¥¼ í†µí•´ ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.</p>';
  h+='<label style="font-size:13px;font-weight:600">Apps Script URL</label>';
  h+='<input id="cfgUrl" style="width:100%;margin:8px 0 16px;padding:8px;border:1px solid var(--gray-300);border-radius:8px;font-size:12px" value="'+esc(SCRIPT_URL)+'" placeholder="https://script.google.com/macros/s/.../exec">';
  h+='<div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">';
  h+='<button class="btn btn-outline btn-sm" onclick="closeModal()">ë‹«ê¸°</button>';
  h+='<button class="btn btn-outline btn-sm" onclick="testCloudConnection()">ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸</button>';
  h+='<button class="btn btn-outline btn-sm" onclick="uploadAllToCloud();closeModal()">ğŸ“¤ ì „ì²´ ì—…ë¡œë“œ</button>';
  h+='<button class="btn btn-blue btn-sm" onclick="saveCloudUrl()">ì €ì¥</button>';
  h+='</div></div>';
  showModal(h);
}
function saveCloudUrl(){
  const url=document.getElementById('cfgUrl').value.trim();
  SCRIPT_URL=url;
  if(url)localStorage.setItem('ws3_script_url',url);
  else localStorage.removeItem('ws3_script_url');
  closeModal();
  if(url){updateSyncStatus('idle');toast('í´ë¼ìš°ë“œ URL ì €ì¥ë¨');}
  else{updateSyncStatus('');toast('í´ë¼ìš°ë“œ ì—°ë™ í•´ì œë¨');}
}
async function testCloudConnection(){
  const url=document.getElementById('cfgUrl').value.trim();
  if(!url){toast('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
  const fullUrl=url+'?action=loadAll';
  // ë°©ë²•1: ì§ì ‘ fetch
  toast('ğŸ” 1/4 ì§ì ‘ ì—°ê²° ì‹œë„...');
  let json=await tryFetch(fullUrl,5000);
  if(json&&json.success){toast('âœ… ì—°ê²° ì„±ê³µ (ì§ì ‘)! ë°ì´í„° '+Object.keys(json.data||{}).length+'ê°œ');return;}
  // ë°©ë²•2: JSONP
  toast('ğŸ” 2/4 JSONP ì‹œë„...');
  json=await tryJsonp(fullUrl,5000);
  if(json&&json.success){toast('âœ… ì—°ê²° ì„±ê³µ (JSONP)! ë°ì´í„° '+Object.keys(json.data||{}).length+'ê°œ');return;}
  // ë°©ë²•3: allorigins í”„ë¡ì‹œ
  toast('ğŸ” 3/4 í”„ë¡ì‹œA ì‹œë„...');
  json=await tryFetch('https://api.allorigins.win/raw?url='+encodeURIComponent(fullUrl),5000);
  if(json&&json.success){toast('âœ… ì—°ê²° ì„±ê³µ (í”„ë¡ì‹œA)! ë°ì´í„° '+Object.keys(json.data||{}).length+'ê°œ');return;}
  // ë°©ë²•4: corsproxy
  toast('ğŸ” 4/4 í”„ë¡ì‹œB ì‹œë„...');
  json=await tryFetch('https://corsproxy.io/?'+encodeURIComponent(fullUrl),5000);
  if(json&&json.success){toast('âœ… ì—°ê²° ì„±ê³µ (í”„ë¡ì‹œB)! ë°ì´í„° '+Object.keys(json.data||{}).length+'ê°œ');return;}
  // ëª¨ë‘ ì‹¤íŒ¨ â†’ ì €ì¥ í…ŒìŠ¤íŠ¸
  toast('âš ï¸ ì½ê¸° 4ê°€ì§€ ë°©ë²• ëª¨ë‘ ì‹¤íŒ¨. ì €ì¥ í…ŒìŠ¤íŠ¸ ì§„í–‰...');
  const origUrl=SCRIPT_URL;SCRIPT_URL=url;
  formPost({action:'save',key:'_test',value:'test_'+new Date().toISOString()});
  SCRIPT_URL=origUrl;
  setTimeout(()=>toast('ğŸ“¤ ì €ì¥ ìš”ì²­ ì „ì†¡ë¨. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ "data" ì‹œíŠ¸ì—ì„œ "_test" í™•ì¸í•´ì£¼ì„¸ìš”.'),3000);
}

// ì‹œì‘
init();
</script></body></html>