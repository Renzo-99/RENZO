<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>목공실 주간업무보고 & 재고관리</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'toss-blue': '#3182F6',
        'toss-blue-light': '#E8F3FF',
        'toss-blue-dark': '#1B64DA',
        'toss-red': '#F04452',
        'toss-red-light': '#FFF0F1',
        'toss-green': '#30B47A',
        'toss-green-light': '#E8FAF0',
      },
      fontFamily: {
        sans: ['Pretendard Variable', '-apple-system', 'system-ui', 'sans-serif'],
      },
      borderRadius: {
        'sm-custom': '8px',
        'md-custom': '12px',
        'lg-custom': '16px',
      }
    }
  }
}
</script>
<style>
body { font-family: 'Pretendard Variable', -apple-system, system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
.slide-up-enter { animation: slideUp 0.3s ease-out; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #D1D6DB; border-radius: 3px; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen flex flex-col overflow-hidden">
<div id="app" class="flex flex-col h-full">
  <!-- Header -->
  <header class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0">
    <div class="flex items-center gap-3">
      <h1 class="text-lg font-bold text-gray-900">목공실 관리</h1>
    </div>
    <div class="flex items-center gap-2">
      <button @click="navigateWeek('prev')" class="p-2 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
      </button>
      <span class="text-sm font-medium text-gray-700 min-w-[180px] text-center">{{ dateRangeText }}</span>
      <button @click="navigateWeek('next')" class="p-2 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
      </button>
    </div>
    <div class="w-[140px]"></div>
  </header>

  <!-- Main -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Left: Report Panel -->
    <div class="flex-1 bg-gray-50 overflow-y-auto">
      <div class="p-6 space-y-6">
        <!-- Summary -->
        <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
          <div class="flex items-center gap-6">
            <div class="text-center"><p class="text-2xl font-extrabold text-gray-900">{{ totalTasks }}</p><p class="text-xs text-gray-500 mt-0.5">작업</p></div>
            <div class="w-px h-8 bg-gray-200"></div>
            <div class="text-center"><p class="text-2xl font-extrabold text-toss-blue">{{ totalMaterials }}</p><p class="text-xs text-gray-500 mt-0.5">자재 사용</p></div>
            <div class="w-px h-8 bg-gray-200"></div>
            <div class="text-center"><p class="text-2xl font-extrabold text-gray-900">{{ uniqueProducts }}</p><p class="text-xs text-gray-500 mt-0.5">품목</p></div>
          </div>
        </div>

        <!-- Day Sections -->
        <div v-for="(day, di) in days" :key="di">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 rounded-full bg-toss-blue"></div>
              <h3 class="text-base font-semibold text-gray-800">{{ day.dayName }}</h3>
              <span class="text-sm text-gray-500">{{ day.date }}</span>
            </div>
            <button @click="addTask(di)" class="flex items-center gap-1 px-3 py-1.5 text-sm text-toss-blue hover:bg-toss-blue-light rounded-lg transition-colors cursor-pointer">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
              작업 추가
            </button>
          </div>
          <div class="space-y-2">
            <p v-if="day.tasks.length === 0" class="text-sm text-gray-400 pl-4">작업이 없습니다</p>
            <div v-for="(task, ti) in day.tasks" :key="task.id"
              class="group bg-white rounded-xl border border-gray-200 p-3 shadow-sm hover:shadow-md transition-shadow"
              :class="{'border-l-[3px] border-l-toss-blue': task.materials.length > 0}">
              <div class="flex items-start gap-3">
                <span class="shrink-0 w-[22px] h-[22px] rounded-full bg-gray-100 text-gray-500 text-xs font-medium flex items-center justify-center mt-0.5">{{ ti + 1 }}</span>
                <div class="flex-1 min-w-0">
                  <input v-if="task.editing" :ref="el => { if(el) el.focus() }"
                    v-model="task.description"
                    @blur="finishEdit(task)" @keydown.enter="finishEdit(task)"
                    class="w-full text-sm text-gray-700 bg-transparent border-none outline-none placeholder:text-gray-400"
                    placeholder="작업 내용을 입력하세요...">
                  <p v-else @click="task.editing = true" class="text-sm text-gray-700 cursor-text">
                    {{ task.description || '작업 내용을 입력하세요...' }}
                  </p>
                  <!-- Materials -->
                  <div v-if="task.materials.length > 0" class="flex flex-wrap gap-1.5 mt-2">
                    <span v-for="m in task.materials" :key="m.id"
                      class="inline-flex items-center gap-1 bg-toss-blue-light text-toss-blue text-xs font-medium px-2 py-1 rounded-full">
                      {{ getProductName(m.productId) }}
                      <span class="bg-toss-blue text-white text-[10px] px-1.5 py-0.5 rounded-full">×{{ m.quantity }}</span>
                      <button @click="removeMaterial(task, m)" class="ml-0.5 hover:bg-toss-blue/20 rounded-full p-0.5 cursor-pointer">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                      </button>
                    </span>
                  </div>
                </div>
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button @click="openMaterialPicker(task)" class="h-7 w-7 flex items-center justify-center rounded-lg text-toss-blue hover:bg-toss-blue-light cursor-pointer">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                  </button>
                  <button @click="deleteTask(di, ti)" class="h-7 w-7 flex items-center justify-center rounded-lg text-gray-400 hover:text-toss-red hover:bg-toss-red-light cursor-pointer">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Inventory Panel -->
    <div class="w-[420px] bg-white border-l border-gray-200 flex flex-col shrink-0">
      <!-- Search & Filter -->
      <div class="p-4 space-y-3 border-b border-gray-200">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input v-model="invSearch" placeholder="품목 검색..." class="w-full pl-9 pr-3 py-2 text-sm rounded-lg border border-gray-200 outline-none focus:border-toss-blue focus:ring-1 focus:ring-toss-blue/30 transition-colors">
        </div>
        <div class="flex gap-1.5">
          <button v-for="f in filters" :key="f.key" @click="invFilter = f.key"
            class="px-3 py-1.5 rounded-full text-xs font-medium transition-colors cursor-pointer"
            :class="invFilter === f.key ? 'bg-toss-blue text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
            {{ f.label }}
          </button>
        </div>
      </div>

      <!-- Product List -->
      <div class="flex-1 overflow-y-auto px-4 pb-4">
        <p v-if="filteredProducts.length === 0" class="text-sm text-gray-400 text-center py-8">
          {{ invSearch ? '검색 결과가 없습니다' : '해당하는 품목이 없습니다' }}
        </p>
        <div v-for="p in filteredProducts" :key="p.id" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 transition-colors">
          <span class="text-[11px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded w-12 text-center shrink-0">{{ p.code }}</span>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">{{ p.name }}</p>
            <p class="text-[11px] text-gray-400">입고 {{ p.total_in }} · 출고 {{ p.total_out }}</p>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <span v-if="p.weeklyChange && p.weeklyChange !== 0"
              class="text-[11px] font-bold px-1.5 py-0.5 rounded-full"
              :class="p.weeklyChange > 0 ? 'bg-toss-green-light text-toss-green' : 'bg-toss-red-light text-toss-red'">
              {{ p.weeklyChange > 0 ? '+' + p.weeklyChange : p.weeklyChange }}
            </span>
            <span class="text-lg font-extrabold min-w-[32px] text-right"
              :class="p.current_stock === 0 ? 'text-gray-400' : p.current_stock <= 5 ? 'text-toss-red' : 'text-gray-900'">
              {{ p.current_stock }}
            </span>
            <span class="text-xs text-gray-400">{{ p.unit }}</span>
          </div>
        </div>
      </div>

      <!-- Inbound Button -->
      <div class="p-4 border-t border-gray-200">
        <button @click="showInbound = true" class="w-full flex items-center justify-center gap-2 bg-toss-blue text-white py-2.5 rounded-lg font-medium text-sm hover:bg-toss-blue-dark transition-colors cursor-pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v12M5 10l7 7 7-7"/><path d="M5 21h14"/></svg>
          입고 등록
        </button>
      </div>
    </div>
  </div>

  <!-- Material Picker Modal -->
  <div v-if="pickerTask" class="fixed inset-0 z-50 flex items-end justify-center">
    <div class="absolute inset-0 bg-black/40" @click="pickerTask = null"></div>
    <div class="relative w-full max-w-lg bg-white rounded-t-2xl shadow-xl max-h-[70vh] flex flex-col slide-up-enter">
      <div class="flex justify-center pt-3 pb-2"><div class="w-9 h-1 rounded-full bg-gray-300"></div></div>

      <!-- Quantity Input -->
      <div v-if="pickerSelected" class="p-5 space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold text-gray-900">수량 입력</h3>
          <button @click="pickerSelected = null" class="cursor-pointer"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
        </div>
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{{ pickerSelected.code }}</span>
            <span class="text-sm font-medium text-gray-800">{{ pickerSelected.name }}</span>
          </div>
          <p class="text-xs text-gray-500 mt-1">현재 재고: {{ pickerSelected.current_stock }}{{ pickerSelected.unit }}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">사용 수량</label>
          <input type="number" v-model.number="pickerQty" :min="1" :max="pickerSelected.current_stock"
            class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 outline-none focus:border-toss-blue focus:ring-1 focus:ring-toss-blue/30">
        </div>
        <div class="flex gap-2">
          <button @click="pickerTask = null" class="flex-1 py-2.5 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 cursor-pointer">취소</button>
          <button @click="confirmMaterial" :disabled="pickerQty < 1 || pickerQty > pickerSelected.current_stock"
            class="flex-1 py-2.5 bg-toss-blue text-white rounded-lg text-sm font-medium hover:bg-toss-blue-dark disabled:opacity-40 disabled:cursor-not-allowed cursor-pointer">출고 확인</button>
        </div>
      </div>

      <!-- Product Search -->
      <template v-else>
        <div class="px-4 pb-3">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input v-model="pickerSearch" placeholder="자재 검색..." class="w-full pl-9 pr-3 py-2 text-sm rounded-lg bg-gray-100 border-none outline-none focus:ring-1 focus:ring-toss-blue/30">
          </div>
        </div>
        <div class="flex-1 overflow-y-auto px-4 pb-4">
          <button v-for="p in pickerFiltered" :key="p.id" @click="selectPickerProduct(p)"
            :disabled="p.current_stock === 0"
            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 text-left cursor-pointer transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
            <span class="text-[11px] font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded w-12 text-center shrink-0">{{ p.code }}</span>
            <span class="text-sm text-gray-700 flex-1 truncate">{{ p.name }}</span>
            <span class="text-sm font-bold" :class="p.current_stock === 0 ? 'text-gray-400' : p.current_stock <= 5 ? 'text-toss-red' : 'text-gray-900'">
              {{ p.current_stock }}{{ p.unit }}
            </span>
          </button>
          <p v-if="pickerFiltered.length === 0" class="text-sm text-gray-400 text-center py-8">검색 결과가 없습니다</p>
        </div>
      </template>
    </div>
  </div>

  <!-- Inbound Modal -->
  <div v-if="showInbound" class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" @click="showInbound = false"></div>
    <div class="relative bg-white rounded-xl shadow-lg w-full max-w-md p-6 space-y-4 mx-4">
      <h2 class="text-lg font-semibold text-gray-900">입고 등록</h2>

      <template v-if="!inboundSelected">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input v-model="inboundSearch" placeholder="상품 검색..." class="w-full pl-9 pr-3 py-2 text-sm rounded-lg border border-gray-200 outline-none focus:border-toss-blue">
        </div>
        <div class="max-h-60 overflow-y-auto">
          <button v-for="p in inboundFiltered" :key="p.id" @click="inboundSelected = p"
            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 text-left cursor-pointer">
            <span class="text-[11px] font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded w-12 text-center">{{ p.code }}</span>
            <span class="text-sm text-gray-700 flex-1 truncate">{{ p.name }}</span>
            <span class="text-sm font-bold text-gray-900">{{ p.current_stock }}{{ p.unit }}</span>
          </button>
        </div>
      </template>

      <template v-else>
        <div class="bg-gray-50 rounded-xl p-3">
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{{ inboundSelected.code }}</span>
            <span class="text-sm font-medium">{{ inboundSelected.name }}</span>
          </div>
          <p class="text-xs text-gray-500 mt-1">현재 재고: {{ inboundSelected.current_stock }}{{ inboundSelected.unit }}</p>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">입고 수량</label>
          <input type="number" v-model.number="inboundQty" min="1"
            class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 outline-none focus:border-toss-blue focus:ring-1 focus:ring-toss-blue/30">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">메모 (선택)</label>
          <input v-model="inboundMemo" placeholder="입고 사유..."
            class="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 outline-none focus:border-toss-blue focus:ring-1 focus:ring-toss-blue/30">
        </div>
        <div class="flex gap-2 pt-2">
          <button @click="showInbound = false" class="flex-1 py-2.5 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 cursor-pointer">취소</button>
          <button @click="processInbound" :disabled="inboundQty < 1"
            class="flex-1 py-2.5 bg-toss-blue text-white rounded-lg text-sm font-medium hover:bg-toss-blue-dark disabled:opacity-40 cursor-pointer">입고 처리</button>
        </div>
      </template>
    </div>
  </div>
</div>

<script>
const DAY_NAMES = ['월요일','화요일','수요일','목요일','금요일'];

const PRODUCTS = [
  {id:1,code:'A01',name:'도어록(문손잡이)_원통형',category:'A',unit:'개',current_stock:37,total_in:52,total_out:15},
  {id:2,code:'A02',name:'도어록(문손잡이)_상자형',category:'A',unit:'개',current_stock:48,total_in:106,total_out:58},
  {id:3,code:'A03',name:'도어클로저_방화문용_K2_840',category:'A',unit:'개',current_stock:8,total_in:23,total_out:15},
  {id:4,code:'A03-1',name:'도어클로저_방화문용_K2_630 (소방)',category:'A',unit:'개',current_stock:20,total_in:20,total_out:0},
  {id:5,code:'A04',name:'도어클로저_일반용_K_620',category:'A',unit:'개',current_stock:15,total_in:45,total_out:30},
  {id:6,code:'A04-1',name:'도어클로저_일반용_K_630',category:'A',unit:'개',current_stock:14,total_in:20,total_out:6},
  {id:7,code:'A05',name:'환풍기_200DRA',category:'A',unit:'대',current_stock:25,total_in:50,total_out:25},
  {id:8,code:'A06',name:'환풍기_250DRA',category:'A',unit:'대',current_stock:15,total_in:32,total_out:17},
  {id:9,code:'A07',name:'플로어힌지_강화문용_양쪽 정지형 K2_8400',category:'A',unit:'개',current_stock:29,total_in:54,total_out:25},
  {id:10,code:'A07-1',name:'플로어힌지 방수_강화문용_양쪽 정지형 K_8400WP',category:'A',unit:'개',current_stock:19,total_in:20,total_out:1},
  {id:11,code:'A08',name:'플로어힌지_강화문용_양쪽 논스톱형 K_8400N',category:'A',unit:'개',current_stock:36,total_in:40,total_out:4},
  {id:12,code:'A09',name:'도어스토퍼 (문발굽)',category:'A',unit:'개',current_stock:376,total_in:385,total_out:9},
  {id:13,code:'A10',name:'오르내리꽂이쇠 (아교도시,보조잠금장치,환락)',category:'A',unit:'개',current_stock:5,total_in:9,total_out:4},
  {id:14,code:'A11',name:'경첩_4인치',category:'A',unit:'개',current_stock:0,total_in:0,total_out:0},
  {id:15,code:'A12',name:'T경첩',category:'A',unit:'개',current_stock:34,total_in:36,total_out:2},
  {id:16,code:'A13',name:'우아미경첩(나비경첩)_2인치',category:'A',unit:'개',current_stock:14,total_in:20,total_out:6},
  {id:17,code:'A14',name:'자유경첩',category:'A',unit:'개',current_stock:0,total_in:0,total_out:0},
  {id:18,code:'A15',name:'수성본드 1KG',category:'A',unit:'포',current_stock:0,total_in:0,total_out:0},
  {id:19,code:'A16',name:'상부보조키(본체정)_강화도어프레임용_M-200',category:'A',unit:'개',current_stock:15,total_in:17,total_out:2},
  {id:20,code:'A17',name:'손잡이 (1자형)',category:'A',unit:'조',current_stock:10,total_in:12,total_out:2},
  {id:21,code:'A18',name:'손잡이 (L자형)',category:'A',unit:'조',current_stock:6,total_in:7,total_out:1},
  {id:22,code:'A19',name:'방충망_90cm*30m',category:'A',unit:'롤',current_stock:2,total_in:3,total_out:1},
  {id:23,code:'A20',name:'방충망_120cm*30m',category:'A',unit:'롤',current_stock:2,total_in:4,total_out:2},
  {id:24,code:'A21',name:'방충망_150cm*30m',category:'A',unit:'롤',current_stock:0,total_in:0,total_out:0},
  {id:25,code:'A22',name:'텍스_6t*300*600mm',category:'A',unit:'개(box)',current_stock:6,total_in:6,total_out:0},
  {id:26,code:'A23',name:'비누걸이',category:'A',unit:'개',current_stock:0,total_in:0,total_out:0},
  {id:27,code:'A24',name:'좌판',category:'A',unit:'개',current_stock:110,total_in:335,total_out:225},
  {id:28,code:'A25',name:'샷시문 손잡이_황동색',category:'A',unit:'조',current_stock:2,total_in:3,total_out:1},
  {id:29,code:'A26',name:'다용도 경첩_6070실버',category:'A',unit:'개',current_stock:81,total_in:93,total_out:12},
  {id:30,code:'A27',name:'경첩',category:'A',unit:'개',current_stock:3,total_in:8,total_out:5},
  {id:31,code:'A28',name:'홍문관 도어체크_ASSA ABLOY U500',category:'A',unit:'개',current_stock:0,total_in:0,total_out:0},
  {id:32,code:'A29',name:'강화도어 단방향 스토퍼',category:'A',unit:'개',current_stock:21,total_in:30,total_out:9},
  {id:33,code:'A30',name:'슬라이딩 도어용 잠금장치',category:'A',unit:'개',current_stock:14,total_in:15,total_out:1},
  {id:34,code:'B01',name:'라왕목재 (3600*24.24*303mm)_12자*0.8치*10치',category:'B',unit:'개',current_stock:3,total_in:3,total_out:0},
  {id:35,code:'B02',name:'라왕목재 (3600*30*303mm)_12자*1치*10치',category:'B',unit:'개',current_stock:5,total_in:5,total_out:0},
  {id:36,code:'B03',name:'라왕목재 (3600*30*45mm)_12자*1치*1.5치',category:'B',unit:'개',current_stock:34,total_in:34,total_out:0},
  {id:37,code:'B04',name:'라왕목재 (3600*36.36*60.6mm)_12자*1.2치*2치',category:'B',unit:'개',current_stock:34,total_in:34,total_out:0},
  {id:38,code:'B05',name:'라왕목재 (3600*36.36*90.9mm)_12자*1.2치*3치',category:'B',unit:'개',current_stock:12,total_in:12,total_out:0},
  {id:39,code:'B06',name:'라왕목재 (3600*45.45*45.45mm)_12자*1.5치*1.5치',category:'B',unit:'개',current_stock:33,total_in:33,total_out:0},
  {id:40,code:'B07',name:'라왕목재 (3600*45.45*210mm)_12자*2치*7치',category:'B',unit:'개',current_stock:5,total_in:5,total_out:0},
  {id:41,code:'B08',name:'라왕목재 (3600*60.6*60.6mm)_12자*2치*2치',category:'B',unit:'개',current_stock:23,total_in:23,total_out:0},
  {id:42,code:'B09',name:'라왕목재 (3600*75.9*75.9mm)_12자*2.5치*2.5치',category:'B',unit:'개',current_stock:12,total_in:12,total_out:0},
  {id:43,code:'B10',name:'방부목_데크용 (21*120*3600mm)',category:'B',unit:'개',current_stock:21,total_in:25,total_out:4},
  {id:44,code:'B11',name:'방부목_데크용 (25*140*3600mm)',category:'B',unit:'개',current_stock:40,total_in:40,total_out:0},
  {id:45,code:'B12',name:'방부목_데크용 (27*140*3600mm)',category:'B',unit:'개',current_stock:0,total_in:0,total_out:0},
  {id:46,code:'B13',name:'방부목 (38*38*3600mm)',category:'B',unit:'개',current_stock:54,total_in:54,total_out:0},
  {id:47,code:'B14',name:'방부목 (50*150*3600mm)',category:'B',unit:'개',current_stock:0,total_in:0,total_out:0},
  {id:48,code:'B15',name:'방부목 (120*210*3600mm)',category:'B',unit:'개',current_stock:0,total_in:6,total_out:6},
  {id:49,code:'B16',name:'방부목_구조용 (38mm*89*3600mm)',category:'B',unit:'개',current_stock:3,total_in:19,total_out:16},
  {id:50,code:'B17',name:'방부목_구조용 (38mm*140*3600mm)',category:'B',unit:'개',current_stock:0,total_in:0,total_out:0},
  {id:51,code:'B18',name:'합판 (5*1220*2440mm)',category:'B',unit:'장',current_stock:5,total_in:5,total_out:0},
  {id:52,code:'B19',name:'합판 (12*1220*2440mm)',category:'B',unit:'장',current_stock:8,total_in:8,total_out:0},
  {id:53,code:'B20',name:'합판 (15*1220*2440mm)',category:'B',unit:'장',current_stock:0,total_in:0,total_out:0},
  {id:54,code:'B21',name:'합판 (18*1220*2440mm)',category:'B',unit:'장',current_stock:0,total_in:0,total_out:0},
  {id:55,code:'B22',name:'못 (1.0인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:56,code:'B23',name:'못 (1.5인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:57,code:'B24',name:'못 (2.0인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:58,code:'B25',name:'못 (2.5인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:59,code:'B26',name:'못 (3.0인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:60,code:'B27',name:'못 (3.5인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:61,code:'B28',name:'무두못 (0.6인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:62,code:'B29',name:'무두못 (1.0인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:63,code:'B30',name:'무두못 (1.5인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:64,code:'B31',name:'무두못 (2.0인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:65,code:'B32',name:'무두못 (2.5인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:66,code:'B33',name:'무두못 (3.0인치)',category:'B',unit:'kg',current_stock:0,total_in:0,total_out:0},
  {id:67,code:'B34',name:'진저샌딩실러',category:'B',unit:'개',current_stock:0,total_in:0,total_out:0},
];

function getISOWeek(d) {
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
}

function getISOWeekYear(d) {
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
  return date.getUTCFullYear();
}

function getMondayOfWeek(year, week) {
  const jan4 = new Date(year, 0, 4);
  const dayOfWeek = jan4.getDay() || 7;
  const monday = new Date(jan4);
  monday.setDate(jan4.getDate() - dayOfWeek + 1 + (week - 1) * 7);
  return monday;
}

function getISOWeeksInYear(year) {
  const dec28 = new Date(year, 11, 28);
  return getISOWeek(dec28);
}

const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

createApp({
  setup() {
    const now = new Date();
    const currentYear = ref(getISOWeekYear(now));
    const currentWeek = ref(getISOWeek(now));
    let nextId = 1;

    // 상품 데이터 (localStorage 연동)
    const products = ref(loadProducts());
    const days = ref(loadDays());

    // 인벤토리 검색/필터
    const invSearch = ref('');
    const invFilter = ref('all');
    const filters = [
      { key: 'all', label: '전체' },
      { key: 'changed', label: '금주 변동' },
      { key: 'low', label: '부족' },
      { key: 'zero', label: '없음' },
    ];

    // 모달 상태
    const pickerTask = ref(null);
    const pickerSearch = ref('');
    const pickerSelected = ref(null);
    const pickerQty = ref(1);

    const showInbound = ref(false);
    const inboundSearch = ref('');
    const inboundSelected = ref(null);
    const inboundQty = ref(1);
    const inboundMemo = ref('');

    // 날짜 계산
    const monday = computed(() => getMondayOfWeek(currentYear.value, currentWeek.value));
    const dateRangeText = computed(() => {
      const m = monday.value;
      const fri = new Date(m); fri.setDate(m.getDate() + 4);
      return `${m.getFullYear()}년 ${m.getMonth()+1}월 ${m.getDate()}일~${fri.getDate()}일 (${currentWeek.value}주차)`;
    });

    function buildDays() {
      const m = monday.value;
      return DAY_NAMES.map((name, i) => {
        const d = new Date(m); d.setDate(m.getDate() + i);
        return {
          dayOfWeek: i,
          dayName: name,
          date: `${d.getMonth()+1}/${d.getDate()}`,
          tasks: [],
        };
      });
    }

    function loadProducts() {
      const saved = localStorage.getItem('ws_products');
      if (saved) return JSON.parse(saved);
      return PRODUCTS.map(p => ({ ...p, weeklyChange: 0 }));
    }

    function loadDays() {
      const key = `ws_days_${currentYear.value}_${currentWeek.value}`;
      const saved = localStorage.getItem(key);
      if (saved) {
        const parsed = JSON.parse(saved);
        nextId = parsed.reduce((max, d) => Math.max(max, ...d.tasks.map(t => Math.max(t.id, ...t.materials.map(m => m.id)))), 0) + 1;
        return parsed;
      }
      return buildDays();
    }

    function saveDays() {
      const key = `ws_days_${currentYear.value}_${currentWeek.value}`;
      localStorage.setItem(key, JSON.stringify(days.value));
    }

    function saveProducts() {
      localStorage.setItem('ws_products', JSON.stringify(products.value));
    }

    // 주차 이동
    function navigateWeek(dir) {
      if (dir === 'prev') {
        if (currentWeek.value <= 1) {
          currentYear.value--;
          currentWeek.value = getISOWeeksInYear(currentYear.value);
        } else {
          currentWeek.value--;
        }
      } else {
        const maxWeek = getISOWeeksInYear(currentYear.value);
        if (currentWeek.value >= maxWeek) {
          currentYear.value++;
          currentWeek.value = 1;
        } else {
          currentWeek.value++;
        }
      }
      days.value = loadDays();
    }

    // 작업 관리
    function addTask(dayIdx) {
      days.value[dayIdx].tasks.push({
        id: nextId++,
        description: '',
        editing: true,
        materials: [],
      });
      saveDays();
    }

    function finishEdit(task) {
      task.editing = false;
      saveDays();
    }

    function deleteTask(dayIdx, taskIdx) {
      const task = days.value[dayIdx].tasks[taskIdx];
      for (const m of task.materials) {
        const p = products.value.find(x => x.id === m.productId);
        if (p) { p.current_stock += m.quantity; p.total_out -= m.quantity; p.weeklyChange = (p.weeklyChange || 0) + m.quantity; }
      }
      days.value[dayIdx].tasks.splice(taskIdx, 1);
      saveDays(); saveProducts();
    }

    // 자재 관리
    function openMaterialPicker(task) {
      pickerTask.value = task;
      pickerSearch.value = '';
      pickerSelected.value = null;
      pickerQty.value = 1;
    }

    function selectPickerProduct(p) {
      pickerSelected.value = p;
      pickerQty.value = 1;
    }

    const pickerFiltered = computed(() => {
      const q = pickerSearch.value.toLowerCase();
      return products.value.filter(p => !q || p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q));
    });

    function confirmMaterial() {
      const p = pickerSelected.value;
      const task = pickerTask.value;
      if (!p || !task) return;
      const qty = Math.max(1, Math.min(pickerQty.value, p.current_stock));
      task.materials.push({ id: nextId++, productId: p.id, quantity: qty });
      p.current_stock -= qty;
      p.total_out += qty;
      p.weeklyChange = (p.weeklyChange || 0) - qty;
      pickerTask.value = null;
      saveDays(); saveProducts();
    }

    function removeMaterial(task, mat) {
      const p = products.value.find(x => x.id === mat.productId);
      if (p) { p.current_stock += mat.quantity; p.total_out -= mat.quantity; p.weeklyChange = (p.weeklyChange || 0) + mat.quantity; }
      task.materials = task.materials.filter(m => m.id !== mat.id);
      saveDays(); saveProducts();
    }

    function getProductName(id) {
      const p = products.value.find(x => x.id === id);
      return p ? p.name : `품목#${id}`;
    }

    // 필터링된 상품 목록
    const filteredProducts = computed(() => {
      return products.value.filter(p => {
        if (invSearch.value) {
          const q = invSearch.value.toLowerCase();
          if (!p.name.toLowerCase().includes(q) && !p.code.toLowerCase().includes(q)) return false;
        }
        if (invFilter.value === 'zero') return p.current_stock === 0;
        if (invFilter.value === 'low') return p.current_stock > 0 && p.current_stock <= 5;
        if (invFilter.value === 'changed') return p.weeklyChange && p.weeklyChange !== 0;
        return true;
      });
    });

    // 입고 처리
    const inboundFiltered = computed(() => {
      const q = inboundSearch.value.toLowerCase();
      return products.value.filter(p => !q || p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q));
    });

    function processInbound() {
      const p = inboundSelected.value;
      if (!p || inboundQty.value < 1) return;
      const prod = products.value.find(x => x.id === p.id);
      if (prod) {
        prod.current_stock += inboundQty.value;
        prod.total_in += inboundQty.value;
        prod.weeklyChange = (prod.weeklyChange || 0) + inboundQty.value;
      }
      showInbound.value = false;
      inboundSelected.value = null;
      inboundSearch.value = '';
      inboundQty.value = 1;
      inboundMemo.value = '';
      saveProducts();
    }

    // 통계
    const totalTasks = computed(() => days.value.reduce((s, d) => s + d.tasks.length, 0));
    const totalMaterials = computed(() => days.value.reduce((s, d) => s + d.tasks.reduce((ss, t) => ss + t.materials.length, 0), 0));
    const uniqueProducts = computed(() => new Set(days.value.flatMap(d => d.tasks.flatMap(t => t.materials.map(m => m.productId)))).size);

    return {
      days, products, currentYear, currentWeek, dateRangeText,
      invSearch, invFilter, filters, filteredProducts,
      navigateWeek, addTask, finishEdit, deleteTask,
      pickerTask, pickerSearch, pickerSelected, pickerQty, pickerFiltered,
      openMaterialPicker, selectPickerProduct, confirmMaterial, removeMaterial, getProductName,
      showInbound, inboundSearch, inboundSelected, inboundQty, inboundMemo, inboundFiltered, processInbound,
      totalTasks, totalMaterials, uniqueProducts,
    };
  }
}).mount('#app');
</script>
</body>
</html>
